#!/usr/bin/env bash
#
# Setup a deploy key for secure git push from sandboxed environments.
# Must be run from within a git repository with a GitHub remote.
#
# Usage: setup-deploy-key [keyname] [-f|--force]
#

set -euo pipefail

die() { echo "error: $*" >&2; exit 1; }

# Parse arguments
FORCE=false
KEYNAME=""

for arg in "$@"; do
    case $arg in
        -h|--help)
            echo "Usage: setup-deploy-key [keyname] [-f|--force]"
            echo "  keyname: Name for the deploy key (default: repo-hostname)"
            echo "  -f:      Overwrite existing key"
            exit 0
            ;;
        -f|--force) FORCE=true ;;
        -*) die "unknown option: $arg" ;;
        *) [[ -z "$KEYNAME" ]] || die "unexpected argument: $arg"; KEYNAME="$arg" ;;
    esac
done

# Must be in a git repo with GitHub origin
[[ -d .git ]] || die "not in a git repository"
ORIGIN_URL=$(git remote get-url origin 2>/dev/null) || die "no origin remote found"
[[ "$ORIGIN_URL" =~ github\.com[:/]([^/]+/[^/.]+)(\.git)?$ ]] || die "not a GitHub repo: $ORIGIN_URL"
REPO="${BASH_REMATCH[1]}"
HOSTNAME=$(hostname -s 2>/dev/null || hostname)
KEYNAME="${KEYNAME:-${REPO#*/}-${HOSTNAME}}"

# Check dependencies
command -v gh >/dev/null || die "gh CLI required"
command -v ssh-keygen >/dev/null || die "ssh-keygen required"
gh auth status >/dev/null 2>&1 || die "run 'gh auth login' first"

KEY_PATH="$HOME/.ssh/deploy_keys/${KEYNAME}"

echo "Setting up deploy key '$KEYNAME' for $REPO"

# Generate key pair
if [[ -f "$KEY_PATH" ]]; then
    [[ "$FORCE" == true ]] || die "key exists: $KEY_PATH (use -f to overwrite)"
    rm -f "$KEY_PATH" "$KEY_PATH.pub"
fi
mkdir -p "$(dirname "$KEY_PATH")" && chmod 700 "$(dirname "$KEY_PATH")"
ssh-keygen -t ed25519 -f "$KEY_PATH" -N "" -C "deploy-key-${KEYNAME}" >/dev/null
chmod 600 "$KEY_PATH" && chmod 644 "$KEY_PATH.pub"

# Add to GitHub
EXISTING_ID=$(gh repo deploy-key list -R "$REPO" --json id,title \
    | jq -r ".[] | select(.title == \"$KEYNAME\") | .id" 2>/dev/null || true)
if [[ -n "$EXISTING_ID" ]]; then
    [[ "$FORCE" == true ]] || die "deploy key '$KEYNAME' exists on GitHub (use -f to overwrite)"
    gh repo deploy-key delete "$EXISTING_ID" -R "$REPO"
fi
gh repo deploy-key add "$KEY_PATH.pub" -R "$REPO" -t "$KEYNAME" -w

echo "Done! Key: $KEY_PATH"
