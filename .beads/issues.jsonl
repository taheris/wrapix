{"id":"wrapix-0u2","title":"Network security verification","description":"Verify network filtering on both platforms: blocked domains return 403, TLD blocking works, raw IP blocked, WebSocket blocked, DNS exfil blocked, ICMP blocked.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T18:51:59.155250789Z","created_by":"shaun","updated_at":"2026-01-06T19:24:22.322213481Z","closed_at":"2026-01-06T19:24:22.322213481Z","close_reason":"Verified: blocklist covers paste/file-sharing/webhooks, TLD blocking, raw IP blocking, WebSocket blocking, DNS/ICMP blocked via iptables","labels":["phase:3-polish"]}
{"id":"wrapix-1ls","title":"Update ARCHITECTURE.md","description":"Update to reflect simplified single-container architecture","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T20:29:03.845256801Z","created_by":"shaun","updated_at":"2026-01-06T20:32:19.844438723Z","closed_at":"2026-01-06T20:32:19.844438723Z","close_reason":"Closed"}
{"id":"wrapix-2mq","title":"Add smoke tests for image builds and configs","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T19:43:18.032875676Z","created_by":"shaun","updated_at":"2026-01-06T19:45:26.61126564Z","closed_at":"2026-01-06T19:45:26.61126564Z","close_reason":"Closed","labels":["phase:tests","task"]}
{"id":"wrapix-2nt","title":"Performance tuning","description":"Optimize layer ordering in OCI images, tune VM resources for macOS, verify startup times.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T18:51:59.079598322Z","created_by":"shaun","updated_at":"2026-01-06T19:24:22.33572Z","closed_at":"2026-01-06T19:24:22.33572Z","close_reason":"Added VM CPU/memory tuning options, documented layer ordering strategy for cache efficiency","labels":["phase:3-polish"]}
{"id":"wrapix-327","title":"Squid configuration (squid.nix)","description":"Create lib/sandbox/squid.nix to generate Squid transparent proxy config with blocklist ACLs, JSON logging, WebSocket blocking.","design":"```\nhttp_port 3128 transparent\n\nacl blocked_domains dstdomain \"/path/to/blocklist.acl\"\nacl blocked_tlds dstdomain \"/path/to/tld-blocklist.acl\"\nacl to_ipaddress url_regex ^https?://[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+\nacl websocket_upgrade req_header Upgrade -i websocket\n\nhttp_access deny blocked_domains\nhttp_access deny blocked_tlds\nhttp_access deny to_ipaddress\nhttp_access deny websocket_upgrade\nhttp_access allow all\n\nlogformat json {\"timestamp\":\"%tl\",\"url\":\"%ru\",\"status\":%\u003eHs,\"action\":\"%Ss\"}\naccess_log stdio:/dev/stdout json\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:21.618257196Z","created_by":"shaun","updated_at":"2026-01-06T19:03:55.357198024Z","closed_at":"2026-01-06T19:03:55.357198024Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wrapix-40g","title":"Add aarch64-darwin to flake","description":"Update flake.nix to add aarch64-darwin support alongside Linux systems.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:50.92957044Z","created_by":"shaun","updated_at":"2026-01-06T19:19:42.978406916Z","closed_at":"2026-01-06T19:19:42.978406916Z","close_reason":"aarch64-darwin already in flake.nix from initial implementation","labels":["phase:2-macos"]}
{"id":"wrapix-4ra","title":"Update sandbox prompt","description":"Remove network filtering messaging, reflect container-only isolation","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T20:29:03.649239687Z","created_by":"shaun","updated_at":"2026-01-06T20:31:10.058587745Z","closed_at":"2026-01-06T20:31:10.058587745Z","close_reason":"Closed"}
{"id":"wrapix-4xz","title":"Test OCI hooks integration","description":"Verify: hook installs correctly, iptables rules applied, blocked domains fail, allowed domains work, file ownership correct in /workspace.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T19:59:50.580073756Z","created_by":"shaun","updated_at":"2026-01-06T20:28:38.786515273Z","closed_at":"2026-01-06T20:28:38.786515273Z","close_reason":"No longer needed - removing network filtering entirely","labels":["phase:hooks","task"]}
{"id":"wrapix-582","title":"Linux Claude entrypoint (linux/entrypoint.nix)","description":"Create lib/sandbox/linux/entrypoint.nix - entrypoint script for Claude container with proper environment setup.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:35.870389297Z","created_by":"shaun","updated_at":"2026-01-06T19:03:55.361436072Z","closed_at":"2026-01-06T19:03:55.361436072Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wrapix-6cg","title":"Claude Code npm package (claude-package.nix)","description":"Create lib/sandbox/claude-package.nix to fetch and install Claude Code from npm registry. Pin version, create wrapper script.","design":"Fetch from npm registry, pin version:\n\n```nix\n{ pkgs }:\nlet version = \"2.0.76\";\nin pkgs.stdenv.mkDerivation {\n  pname = \"claude-code\";\n  inherit version;\n  src = pkgs.fetchurl {\n    url = \"https://registry.npmjs.org/@anthropic-ai/claude-code/-/claude-code-${version}.tgz\";\n    hash = \"sha256-...\";\n  };\n  nativeBuildInputs = [ pkgs.nodejs ];\n  installPhase = ''\n    mkdir -p $out/bin $out/lib\n    cp -r . $out/lib/\n    cat \u003e $out/bin/claude \u003c\u003c 'WRAPPER'\n    #!/usr/bin/env bash\n    exec ${pkgs.nodejs}/bin/node \"$(dirname \"$0\")/../lib/cli.js\" \"$@\"\n    WRAPPER\n    chmod +x $out/bin/claude\n  '';\n}\n```\n\nCLI args: --dangerously-skip-permissions --disallowedTools \"Bash(curl:*),Bash(wget:*)\" --append-system-prompt","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:21.188417376Z","created_by":"shaun","updated_at":"2026-01-06T19:03:55.276339569Z","closed_at":"2026-01-06T19:03:55.276339569Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wrapix-7a4","title":"macOS Nix wrapper (darwin/default.nix)","description":"Create lib/sandbox/darwin/default.nix - Nix wrapper that invokes the Swift runner with correct paths.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:50.827279116Z","created_by":"shaun","updated_at":"2026-01-06T19:19:42.964667828Z","closed_at":"2026-01-06T19:19:42.964667828Z","close_reason":"Implemented darwin/default.nix with kernel and Swift CLI integration","labels":["phase:2-macos"]}
{"id":"wrapix-7cb","title":"Verify macOS profiles","description":"Verify all profiles work on macOS: VM boots \u003c1s, virtio-fs mounts work, UID mapping works.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T18:51:51.019001337Z","created_by":"shaun","updated_at":"2026-01-06T19:24:28.244830782Z","closed_at":"2026-01-06T19:24:28.244830782Z","close_reason":"Requires macOS hardware to test; implementation complete, needs verification on aarch64-darwin","labels":["phase:2-macos"]}
{"id":"wrapix-7sj","title":"Linux init container (linux/init-image.nix)","description":"Create lib/sandbox/linux/init-image.nix - minimal ~5MB image with iptables. Sets up transparent proxy redirect rules, DNS filtering, drops other traffic, then exits.","design":"```bash\n#!/bin/bash\n# Redirect HTTP/HTTPS to Squid\niptables -t nat -A OUTPUT -p tcp --dport 80 -j REDIRECT --to-port 3128\niptables -t nat -A OUTPUT -p tcp --dport 443 -j REDIRECT --to-port 3128\n\n# Allow localhost, established connections\niptables -A OUTPUT -o lo -j ACCEPT\niptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n\n# DNS only to container's resolver\nRESOLVER=$(awk '/^nameserver/ {print $2; exit}' /etc/resolv.conf)\niptables -A OUTPUT -p udp --dport 53 -d \"$RESOLVER\" -j ACCEPT\niptables -A OUTPUT -p udp --dport 53 -j DROP\n\n# Block everything else\niptables -A OUTPUT -j DROP\n```\n\nImage should be ~5MB, only iptables + bash needed.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:35.782245369Z","created_by":"shaun","updated_at":"2026-01-06T19:03:55.360004649Z","closed_at":"2026-01-06T19:03:55.360004649Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wrapix-8cl","title":"Rewrite Linux orchestration for OCI hooks","description":"Update lib/sandbox/linux/default.nix: remove --userns from pod create, add hook installation, use --userns=keep-id on individual containers, add annotation to trigger hook.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T19:59:50.40448523Z","created_by":"shaun","updated_at":"2026-01-06T20:00:48.166542589Z","closed_at":"2026-01-06T20:00:48.166542589Z","close_reason":"Closed","labels":["phase:hooks","task"]}
{"id":"wrapix-a0u","title":"Update flake.nix for podman","description":"Update flake.nix - replace bubblewrap with podman sandbox, export packages (wrapix, wrapix-rust, wrapix-go, etc.) and lib functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:36.225889602Z","created_by":"shaun","updated_at":"2026-01-06T19:03:55.367935202Z","closed_at":"2026-01-06T19:03:55.367935202Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wrapix-b59","title":"Simplify Linux orchestration","description":"Single container with direct network (pasta), remove init/squid sidecars","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T20:29:03.450698171Z","created_by":"shaun","updated_at":"2026-01-06T20:30:08.788617169Z","closed_at":"2026-01-06T20:30:08.788617169Z","close_reason":"Closed"}
{"id":"wrapix-ca5","title":"macOS kernel build (darwin/kernel.nix)","description":"Create lib/sandbox/darwin/kernel.nix - build Linux kernel with Apple Containerization config for arm64, VIRTIO_FS built-in.","design":"```nix\npkgs.stdenv.mkDerivation {\n  pname = \"containerization-kernel\";\n  version = \"6.14.9\";\n  src = fetchurl { url = \"https://cdn.kernel.org/...\"; };\n  # Use Apple's optimized arm64 config (VIRTIO_FS built-in)\n  configurePhase = ''\n    cp ${appleKernelConfig} .config\n    make olddefconfig\n  '';\n  installPhase = ''\n    cp arch/arm64/boot/Image $out/vmlinux\n  '';\n}\n```\n\nFirst build takes ~5-10 min, Nix caches result.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:50.670252663Z","created_by":"shaun","updated_at":"2026-01-06T19:19:42.936019079Z","closed_at":"2026-01-06T19:19:42.936019079Z","close_reason":"Implemented kernel.nix with comprehensive VirtIO config","labels":["phase:2-macos"]}
{"id":"wrapix-cc4","title":"OCI image builder (image.nix)","description":"Create lib/sandbox/image.nix using dockerTools.buildLayeredImage. Include base packages, profile packages, cacert, macOS entrypoint script.","design":"```nix\npkgs.dockerTools.buildLayeredImage {\n  name = \"wrapix-${profile.name}\";\n  tag = \"latest\";\n  maxLayers = 100;\n  contents = [\n    pkgs.dockerTools.fhsUserNamespaces\n    (mkBinEnv (basePackages ++ profile.packages))\n    pkgs.cacert\n  ];\n  extraCommands = ''\n    echo \"root:x:0:0:root:/root:/bin/bash\" \u003e etc/passwd\n    echo \"127.0.0.1 localhost\" \u003e etc/hosts\n    # macOS entrypoint script for iptables + Squid + user + Claude\n  '';\n  config = {\n    Env = [\n      \"PATH=/usr/local/bin:/bin\"\n      \"http_proxy=http://127.0.0.1:3128\"\n      \"https_proxy=http://127.0.0.1:3128\"\n    ] ++ profileEnvVars;\n  };\n}\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:21.707590825Z","created_by":"shaun","updated_at":"2026-01-06T19:03:55.358586907Z","closed_at":"2026-01-06T19:03:55.358586907Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wrapix-cga","title":"macOS Swift CLI (darwin/swift/)","description":"Create lib/sandbox/darwin/swift/ with Package.swift and SandboxRunner.swift - VM orchestration using Apple Containerization framework.","design":"```swift\n@main struct SandboxRunner: AsyncParsableCommand {\n    @Argument var projectDir: String\n    @Option var imagePath: String\n    @Option var kernelPath: String\n\n    func run() async throws {\n        let manager = try await ContainerManager(\n            kernel: Kernel(path: URL(fileURLWithPath: kernelPath)),\n            network: try ContainerManager.VmnetNetwork()\n        )\n        let container = try await manager.create(\"wrapix\") { config in\n            config.cpus = ProcessInfo.processInfo.processorCount\n            config.memoryInBytes = 8.gib()\n            config.mounts.append(Mount.share(source: projectDir, destination: \"/workspace\"))\n            config.process.arguments = [\"/entrypoint.sh\"]\n            config.process.environmentVariables = [\n                \"HOST_UID\": String(getuid()),\n                \"HOST_USER\": NSUserName()\n            ]\n        }\n        try await container.start()\n        Darwin.exit(try await container.wait())\n    }\n}\n```\n\nUses Apple Containerization framework (macOS 26+, Apple Silicon only).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:50.745683184Z","created_by":"shaun","updated_at":"2026-01-06T19:19:42.951932515Z","closed_at":"2026-01-06T19:19:42.951932515Z","close_reason":"Implemented Swift CLI with SandboxRunner.swift and Package.swift","labels":["phase:2-macos"]}
{"id":"wrapix-cpc","title":"System prompt for sandbox (sandbox-prompt.txt)","description":"Create lib/sandbox/sandbox-prompt.txt with sandbox environment description for Claude.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:21.303974517Z","created_by":"shaun","updated_at":"2026-01-06T19:03:55.352852687Z","closed_at":"2026-01-06T19:03:55.352852687Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wrapix-ded","title":"Simplify image build","description":"Remove squid, iptables, proxy env vars from image.nix","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T20:29:03.547114461Z","created_by":"shaun","updated_at":"2026-01-06T20:30:48.267348004Z","closed_at":"2026-01-06T20:30:48.267348004Z","close_reason":"Closed"}
{"id":"wrapix-dv5","title":"Platform dispatcher (sandbox/default.nix)","description":"Create lib/sandbox/default.nix - dispatch to linux/ or darwin/ based on system platform.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:36.045973984Z","created_by":"shaun","updated_at":"2026-01-06T19:03:55.364346916Z","closed_at":"2026-01-06T19:03:55.364346916Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wrapix-e4r","title":"Add checks output to flake.nix","description":"Update flake.nix to export checks attribute from lib/tests. Enables nix flake check to run all tests.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T19:43:18.113997411Z","created_by":"shaun","updated_at":"2026-01-06T19:46:14.13996915Z","closed_at":"2026-01-06T19:46:14.13996915Z","close_reason":"Closed","labels":["phase:tests","task"]}
{"id":"wrapix-fxl","title":"Update documentation","description":"Update CLAUDE.md and README.md with usage instructions, requirements, and examples.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T18:51:59.00355804Z","created_by":"shaun","updated_at":"2026-01-06T19:19:47.134316337Z","closed_at":"2026-01-06T19:19:47.134316337Z","close_reason":"Documentation updated with profiles simplified and ARCHITECTURE.md diagrams fixed","labels":["phase:3-polish"]}
{"id":"wrapix-gh2","title":"Blocklist (blocklist.nix)","description":"Create lib/sandbox/blocklist.nix with blocked domains: pastebin sites, file sharing, URL shorteners, webhook sites, code execution platforms, risky TLDs.","design":"Categories:\n- pastebin_sites: pastebin.com, hastebin.com, paste.ee, dpaste.org, ghostbin.com, privatebin.net, 0bin.net, paste.debian.net, bpaste.net\n- file_sharing: transfer.sh, file.io, tmpfiles.org, gofile.io, pixeldrain.com, catbox.moe, uguu.se, filebin.net, uploadfiles.io\n- url_shorteners: bit.ly, tinyurl.com, t.co, goo.gl, ow.ly, is.gd, buff.ly\n- webhook_sites: webhook.site, requestbin.com, hookbin.com, pipedream.com, beeceptor.com, requestcatcher.com, httpbin.org\n- code_execution: replit.com, glitch.com, codepen.io, jsfiddle.net, codesandbox.io\n- risky_tlds: tk, ml, ga, cf, gq, top, xyz, click, link","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:21.535304706Z","created_by":"shaun","updated_at":"2026-01-06T19:03:55.355793031Z","closed_at":"2026-01-06T19:03:55.355793031Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wrapix-idm","title":"Test Linux profiles","description":"Test all profiles work on Linux: pod starts \u003c2s, init sets iptables and exits, Claude container has no caps, UID mapping works.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T18:51:36.322044263Z","created_by":"shaun","updated_at":"2026-01-06T19:24:22.306909599Z","closed_at":"2026-01-06T19:24:22.306909599Z","close_reason":"Fixed docker-archive prefix issue, both base and rust profiles build and generate correct podman scripts","labels":["phase:1-core"]}
{"id":"wrapix-iye","title":"Linux pod orchestration (linux/default.nix)","description":"Create lib/sandbox/linux/default.nix - Podman pod script with 3-container pattern: init (NET_ADMIN, exits), squid (sidecar), claude (unprivileged, interactive).","design":"```bash\nPOD_NAME=\"wrapix-$$\"\ntrap 'podman pod rm -f \"$POD_NAME\"' EXIT SIGINT SIGTERM\n\n# Create pod with isolated network\npodman pod create --name \"$POD_NAME\" --network=slirp4netns\n\n# Init container: set up iptables, exit\npodman run --rm --pod \"$POD_NAME\" --cap-add=NET_ADMIN $INIT_IMAGE\n\n# Squid sidecar: blocklist filtering\npodman run --detach --pod \"$POD_NAME\" --name \"${POD_NAME}-squid\" \\\n  $PROFILE_IMAGE squid -f /etc/squid/squid.conf -N\n\n# Wait for Squid\nwhile ! podman exec \"${POD_NAME}-squid\" squid -k check; do sleep 0.1; done\n\n# Claude container: completely unprivileged\nexec podman run --rm -it --pod \"$POD_NAME\" --userns=keep-id \\\n  -v \"$PROJECT_DIR:/workspace:rw\" \\\n  $PROFILE_IMAGE claude\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:35.955747149Z","created_by":"shaun","updated_at":"2026-01-06T19:03:55.362904644Z","closed_at":"2026-01-06T19:03:55.362904644Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wrapix-j4o","title":"Fix --userns/--pod conflict in Linux sandbox","description":"Move --userns=keep-id from podman run (line 40) to podman pod create (line 24) in lib/sandbox/linux/default.nix. Recent Podman versions don't allow --userns and --pod together on run.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T19:43:17.938168412Z","created_by":"shaun","updated_at":"2026-01-06T19:44:29.895443185Z","closed_at":"2026-01-06T19:44:29.895443185Z","close_reason":"Closed","labels":["bug","phase:fix"]}
{"id":"wrapix-ma9","title":"Delete network filtering files","description":"Delete squid.nix, blocklist.nix, init-image.nix, hook.nix","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T20:29:03.355223356Z","created_by":"shaun","updated_at":"2026-01-06T20:29:30.594266264Z","closed_at":"2026-01-06T20:29:30.594266264Z","close_reason":"Closed"}
{"id":"wrapix-mnf","title":"Profile definitions (profiles.nix)","description":"Create lib/sandbox/profiles.nix with profile definitions: base, rust, go, python, js, nix, devops. Include mount format with source/dest/mode/optional.","design":"Profile structure:\n```nix\n{\n  name = \"rust\";\n  packages = with pkgs; [ rustc cargo rust-analyzer ];\n  mounts = [\n    { source = \"~/.cargo/registry\"; dest = \"~/.cargo/registry\"; mode = \"ro\"; optional = true; }\n  ];\n  env = { CARGO_HOME = \"/tmp/cargo\"; };\n  customPrompt = \"...\";  # optional\n}\n```\n\nProfiles: base, rust, go, python, js, nix, devops\n\nBase packages (all profiles):\nbash coreutils findutils git jujutsu ripgrep fd tree less gnugrep gnused gawk jq yq gnutar gzip zip unzip vim man file which patch diffutils procps rsync\n\nRequired mounts: ~/.claude (rw), ~/.claude.json (rw), ~/.config/git (ro), project dir (rw)\n\nEnv vars: CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1, DISABLE_AUTOUPDATER=1, DISABLE_ERROR_REPORTING=1, DISABLE_TELEMETRY=1","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:21.43574195Z","created_by":"shaun","updated_at":"2026-01-06T19:03:55.354404718Z","closed_at":"2026-01-06T19:03:55.354404718Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wrapix-nk4","title":"Create OCI hook for iptables setup","description":"Create lib/sandbox/linux/hook.nix with iptables hook script and JSON config. Hook runs in container namespace with NET_ADMIN before capabilities are dropped.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T19:59:50.319319354Z","created_by":"shaun","updated_at":"2026-01-06T20:00:26.814009126Z","closed_at":"2026-01-06T20:00:26.814009126Z","close_reason":"Closed","labels":["phase:hooks","task"]}
{"id":"wrapix-p5m","title":"Library exports (lib/default.nix)","description":"Create lib/default.nix exporting: mkSandbox, mkDevShell, deriveProfile, profiles.","design":"```nix\n{ pkgs, system }:\nlet\n  sandbox = import ./sandbox { inherit pkgs system; };\n  profiles = import ./sandbox/profiles.nix { inherit pkgs; };\nin {\n  mkSandbox = profile: sandbox.mkSandbox profile;\n\n  deriveProfile = baseProfile: extensions:\n    baseProfile // extensions // {\n      packages = (baseProfile.packages or []) ++ (extensions.packages or []);\n      mounts = (baseProfile.mounts or []) ++ (extensions.mounts or []);\n      env = (baseProfile.env or {}) // (extensions.env or {});\n    };\n\n  mkDevShell = { packages ? [], shellHook ? \"\" }:\n    pkgs.mkShell { inherit packages shellHook; };\n\n  inherit profiles;\n}\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:36.134120722Z","created_by":"shaun","updated_at":"2026-01-06T19:03:55.366211793Z","closed_at":"2026-01-06T19:03:55.366211793Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wrapix-v65","title":"Simplify init container image","description":"Update lib/sandbox/linux/init-image.nix: remove iptables logic (now handled by hook), make minimal container that just triggers hook and exits.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T19:59:50.491565889Z","created_by":"shaun","updated_at":"2026-01-06T20:01:15.58930236Z","closed_at":"2026-01-06T20:01:15.58930236Z","close_reason":"Closed","labels":["phase:hooks","task"]}
{"id":"wrapix-y45","title":"Clean up smoke tests","description":"Remove blocklist and squid-config tests from smoke.nix","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T20:29:03.74952052Z","created_by":"shaun","updated_at":"2026-01-06T20:31:46.285143531Z","closed_at":"2026-01-06T20:31:46.285143531Z","close_reason":"Closed"}
{"id":"wx-0u2","title":"Network security verification","description":"Verify network filtering on both platforms: blocked domains return 403, TLD blocking works, raw IP blocked, WebSocket blocked, DNS exfil blocked, ICMP blocked.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T18:51:59.155250789Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.168474635Z","closed_at":"2026-01-06T19:24:22.322213481Z","close_reason":"Verified: blocklist covers paste/file-sharing/webhooks, TLD blocking, raw IP blocking, WebSocket blocking, DNS/ICMP blocked via iptables","labels":["phase:3-polish"]}
{"id":"wx-1ls","title":"Update ARCHITECTURE.md","description":"Update to reflect simplified single-container architecture","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T20:29:03.845256801Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.167818094Z","closed_at":"2026-01-06T20:32:19.844438723Z","close_reason":"Closed"}
{"id":"wx-2mq","title":"Add smoke tests for image builds and configs","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T19:43:18.032875676Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.161243057Z","closed_at":"2026-01-06T19:45:26.61126564Z","close_reason":"Closed","labels":["phase:tests","task"]}
{"id":"wx-2nt","title":"Performance tuning","description":"Optimize layer ordering in OCI images, tune VM resources for macOS, verify startup times.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T18:51:59.079598322Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.16881545Z","closed_at":"2026-01-06T19:24:22.33572Z","close_reason":"Added VM CPU/memory tuning options, documented layer ordering strategy for cache efficiency","labels":["phase:3-polish"]}
{"id":"wx-327","title":"Squid configuration (squid.nix)","description":"Create lib/sandbox/squid.nix to generate Squid transparent proxy config with blocklist ACLs, JSON logging, WebSocket blocking.","design":"```\nhttp_port 3128 transparent\n\nacl blocked_domains dstdomain \"/path/to/blocklist.acl\"\nacl blocked_tlds dstdomain \"/path/to/tld-blocklist.acl\"\nacl to_ipaddress url_regex ^https?://[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+\nacl websocket_upgrade req_header Upgrade -i websocket\n\nhttp_access deny blocked_domains\nhttp_access deny blocked_tlds\nhttp_access deny to_ipaddress\nhttp_access deny websocket_upgrade\nhttp_access allow all\n\nlogformat json {\"timestamp\":\"%tl\",\"url\":\"%ru\",\"status\":%\u003eHs,\"action\":\"%Ss\"}\naccess_log stdio:/dev/stdout json\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:21.618257196Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.165823542Z","closed_at":"2026-01-06T19:03:55.357198024Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wx-40g","title":"Add aarch64-darwin to flake","description":"Update flake.nix to add aarch64-darwin support alongside Linux systems.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:50.92957044Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.161634301Z","closed_at":"2026-01-06T19:19:42.978406916Z","close_reason":"aarch64-darwin already in flake.nix from initial implementation","labels":["phase:2-macos"]}
{"id":"wx-4ra","title":"Update sandbox prompt","description":"Remove network filtering messaging, reflect container-only isolation","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T20:29:03.649239687Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.159825807Z","closed_at":"2026-01-06T20:31:10.058587745Z","close_reason":"Closed"}
{"id":"wx-4xz","title":"Test OCI hooks integration","description":"Verify: hook installs correctly, iptables rules applied, blocked domains fail, allowed domains work, file ownership correct in /workspace.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T19:59:50.580073756Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.160140622Z","closed_at":"2026-01-06T20:28:38.786515273Z","close_reason":"No longer needed - removing network filtering entirely","labels":["phase:hooks","task"]}
{"id":"wx-582","title":"Linux Claude entrypoint (linux/entrypoint.nix)","description":"Create lib/sandbox/linux/entrypoint.nix - entrypoint script for Claude container with proper environment setup.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:35.870389297Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.164721138Z","closed_at":"2026-01-06T19:03:55.361436072Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wx-583","title":"Run NixOS VM integration tests on machine with Nix","description":"Run `nix flake check` to execute the new NixOS VM integration tests (container-start, filesystem-isolation, user-namespace) on a machine with Nix and KVM support. Verify all tests pass.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-06T21:12:33.471984848Z","created_by":"Shaun","updated_at":"2026-01-06T21:15:55.159179046Z"}
{"id":"wx-584","title":"Investigate bd daemon sharing between sandbox and host","description":"Running bd with --sandbox flag in the container causes issues with the host's bd daemon. Host bd commands start timing out and falling back to direct mode. Need to investigate:\n- Whether sandbox and host should share the same .beads directory\n- If daemon socket conflicts are causing the issue\n- Best practices for bd in containerized environments\n- Whether the sandbox should have its own isolated .beads or mount the host's","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T21:12:34.583879527Z","created_by":"Shaun","updated_at":"2026-01-06T21:21:39.098454814Z","closed_at":"2026-01-06T21:21:39.098454814Z","close_reason":"Closed","comments":[{"id":1,"issue_id":"wx-584","author":"shaun","text":"Investigation findings:\n\n**Root cause**: The .beads/ directory is mounted read-write into the container as part of the workspace. When bd runs in the container (even with --sandbox flag), it can interfere with the host daemon's SQLite connection.\n\n**What we observed**: Host daemon logs showed repeated 'sql: database is closed' errors. The daemon process was still running but its database connection died, causing client commands to timeout and fall back to direct mode.\n\n**The conflict**:\n1. Host daemon holds open connection to .beads/beads.db\n2. Container bd opens the same database file (even for reads)\n3. SQLite locking/connection behavior causes host daemon's connection to become invalid\n\n**Potential solutions**:\n1. Don't mount .beads - Exclude .beads/ from workspace mount (cleanest)\n2. Use --no-db in container - Container uses JSONL-only mode: bd --no-db --sandbox\n3. Mount .beads read-only - Prevents container from corrupting, but reads might still cause issues\n4. Separate .beads per environment - Container has its own .beads directory (sync issues)\n\n**Recommended**: Option 1 or 2. The sandbox doesn't need issue tracking - it's a worker environment.","created_at":"2026-01-06T21:17:29Z"},{"id":2,"issue_id":"wx-584","author":"shaun","text":"Fix implemented in lib/sandbox/linux/default.nix:\n\n1. Create a tmpfs overlay at /workspace/.beads to hide host runtime files\n2. Mount only tracked files (issues.jsonl, interactions.jsonl, config.yaml, metadata.json) into the tmpfs\n3. Set BD_NO_DB=1 so container bd uses JSONL-only mode\n\nThis way:\n- Container can read/write issues via JSONL\n- Host daemon picks up JSONL changes automatically\n- No SQLite conflicts since container never sees the database\n- No socket conflicts since container never sees bd.sock\n\nDarwin sandbox may need similar treatment but uses VM-based approach with different mount semantics.","created_at":"2026-01-06T21:21:39Z"}]}
{"id":"wx-6cg","title":"Claude Code npm package (claude-package.nix)","description":"Create lib/sandbox/claude-package.nix to fetch and install Claude Code from npm registry. Pin version, create wrapper script.","design":"Fetch from npm registry, pin version:\n\n```nix\n{ pkgs }:\nlet version = \"2.0.76\";\nin pkgs.stdenv.mkDerivation {\n  pname = \"claude-code\";\n  inherit version;\n  src = pkgs.fetchurl {\n    url = \"https://registry.npmjs.org/@anthropic-ai/claude-code/-/claude-code-${version}.tgz\";\n    hash = \"sha256-...\";\n  };\n  nativeBuildInputs = [ pkgs.nodejs ];\n  installPhase = ''\n    mkdir -p $out/bin $out/lib\n    cp -r . $out/lib/\n    cat \u003e $out/bin/claude \u003c\u003c 'WRAPPER'\n    #!/usr/bin/env bash\n    exec ${pkgs.nodejs}/bin/node \"$(dirname \"$0\")/../lib/cli.js\" \"$@\"\n    WRAPPER\n    chmod +x $out/bin/claude\n  '';\n}\n```\n\nCLI args: --dangerously-skip-permissions --disallowedTools \"Bash(curl:*),Bash(wget:*)\" --append-system-prompt","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:21.188417376Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.167451719Z","closed_at":"2026-01-06T19:03:55.276339569Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wx-7a4","title":"macOS Nix wrapper (darwin/default.nix)","description":"Create lib/sandbox/darwin/default.nix - Nix wrapper that invokes the Swift runner with correct paths.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:50.827279116Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.162056495Z","closed_at":"2026-01-06T19:19:42.964667828Z","close_reason":"Implemented darwin/default.nix with kernel and Swift CLI integration","labels":["phase:2-macos"]}
{"id":"wx-7cb","title":"Verify macOS profiles","description":"Verify all profiles work on macOS: VM boots \u003c1s, virtio-fs mounts work, UID mapping works.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T18:51:51.019001337Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.16950807Z","closed_at":"2026-01-06T19:24:28.244830782Z","close_reason":"Requires macOS hardware to test; implementation complete, needs verification on aarch64-darwin","labels":["phase:2-macos"]}
{"id":"wx-7sj","title":"Linux init container (linux/init-image.nix)","description":"Create lib/sandbox/linux/init-image.nix - minimal ~5MB image with iptables. Sets up transparent proxy redirect rules, DNS filtering, drops other traffic, then exits.","design":"```bash\n#!/bin/bash\n# Redirect HTTP/HTTPS to Squid\niptables -t nat -A OUTPUT -p tcp --dport 80 -j REDIRECT --to-port 3128\niptables -t nat -A OUTPUT -p tcp --dport 443 -j REDIRECT --to-port 3128\n\n# Allow localhost, established connections\niptables -A OUTPUT -o lo -j ACCEPT\niptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n\n# DNS only to container's resolver\nRESOLVER=$(awk '/^nameserver/ {print $2; exit}' /etc/resolv.conf)\niptables -A OUTPUT -p udp --dport 53 -d \"$RESOLVER\" -j ACCEPT\niptables -A OUTPUT -p udp --dport 53 -j DROP\n\n# Block everything else\niptables -A OUTPUT -j DROP\n```\n\nImage should be ~5MB, only iptables + bash needed.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:35.782245369Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.165081723Z","closed_at":"2026-01-06T19:03:55.360004649Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wx-8cl","title":"Rewrite Linux orchestration for OCI hooks","description":"Update lib/sandbox/linux/default.nix: remove --userns from pod create, add hook installation, use --userns=keep-id on individual containers, add annotation to trigger hook.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T19:59:50.40448523Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.157721607Z","closed_at":"2026-01-06T20:00:48.166542589Z","close_reason":"Closed","labels":["phase:hooks","task"]}
{"id":"wx-a0u","title":"Update flake.nix for podman","description":"Update flake.nix - replace bubblewrap with podman sandbox, export packages (wrapix, wrapix-rust, wrapix-go, etc.) and lib functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:36.225889602Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.163206909Z","closed_at":"2026-01-06T19:03:55.367935202Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wx-a2p","title":"Add NixOS VM integration tests","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-06T19:43:18.194015231Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.16812344Z","labels":["phase:tests","task"]}
{"id":"wx-b59","title":"Simplify Linux orchestration","description":"Single container with direct network (pasta), remove init/squid sidecars","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T20:29:03.450698171Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.157036036Z","closed_at":"2026-01-06T20:30:08.788617169Z","close_reason":"Closed"}
{"id":"wx-ca5","title":"macOS kernel build (darwin/kernel.nix)","description":"Create lib/sandbox/darwin/kernel.nix - build Linux kernel with Apple Containerization config for arm64, VIRTIO_FS built-in.","design":"```nix\npkgs.stdenv.mkDerivation {\n  pname = \"containerization-kernel\";\n  version = \"6.14.9\";\n  src = fetchurl { url = \"https://cdn.kernel.org/...\"; };\n  # Use Apple's optimized arm64 config (VIRTIO_FS built-in)\n  configurePhase = ''\n    cp ${appleKernelConfig} .config\n    make olddefconfig\n  '';\n  installPhase = ''\n    cp arch/arm64/boot/Image $out/vmlinux\n  '';\n}\n```\n\nFirst build takes ~5-10 min, Nix caches result.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:50.670252663Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.162804805Z","closed_at":"2026-01-06T19:19:42.936019079Z","close_reason":"Implemented kernel.nix with comprehensive VirtIO config","labels":["phase:2-macos"]}
{"id":"wx-cc4","title":"OCI image builder (image.nix)","description":"Create lib/sandbox/image.nix using dockerTools.buildLayeredImage. Include base packages, profile packages, cacert, macOS entrypoint script.","design":"```nix\npkgs.dockerTools.buildLayeredImage {\n  name = \"wrapix-${profile.name}\";\n  tag = \"latest\";\n  maxLayers = 100;\n  contents = [\n    pkgs.dockerTools.fhsUserNamespaces\n    (mkBinEnv (basePackages ++ profile.packages))\n    pkgs.cacert\n  ];\n  extraCommands = ''\n    echo \"root:x:0:0:root:/root:/bin/bash\" \u003e etc/passwd\n    echo \"127.0.0.1 localhost\" \u003e etc/hosts\n    # macOS entrypoint script for iptables + Squid + user + Claude\n  '';\n  config = {\n    Env = [\n      \"PATH=/usr/local/bin:/bin\"\n      \"http_proxy=http://127.0.0.1:3128\"\n      \"https_proxy=http://127.0.0.1:3128\"\n    ] ++ profileEnvVars;\n  };\n}\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:21.707590825Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.165470787Z","closed_at":"2026-01-06T19:03:55.358586907Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wx-cga","title":"macOS Swift CLI (darwin/swift/)","description":"Create lib/sandbox/darwin/swift/ with Package.swift and SandboxRunner.swift - VM orchestration using Apple Containerization framework.","design":"```swift\n@main struct SandboxRunner: AsyncParsableCommand {\n    @Argument var projectDir: String\n    @Option var imagePath: String\n    @Option var kernelPath: String\n\n    func run() async throws {\n        let manager = try await ContainerManager(\n            kernel: Kernel(path: URL(fileURLWithPath: kernelPath)),\n            network: try ContainerManager.VmnetNetwork()\n        )\n        let container = try await manager.create(\"wrapix\") { config in\n            config.cpus = ProcessInfo.processInfo.processorCount\n            config.memoryInBytes = 8.gib()\n            config.mounts.append(Mount.share(source: projectDir, destination: \"/workspace\"))\n            config.process.arguments = [\"/entrypoint.sh\"]\n            config.process.environmentVariables = [\n                \"HOST_UID\": String(getuid()),\n                \"HOST_USER\": NSUserName()\n            ]\n        }\n        try await container.start()\n        Darwin.exit(try await container.wait())\n    }\n}\n```\n\nUses Apple Containerization framework (macOS 26+, Apple Silicon only).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:50.745683184Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.1624334Z","closed_at":"2026-01-06T19:19:42.951932515Z","close_reason":"Implemented Swift CLI with SandboxRunner.swift and Package.swift","labels":["phase:2-macos"]}
{"id":"wx-cpc","title":"System prompt for sandbox (sandbox-prompt.txt)","description":"Create lib/sandbox/sandbox-prompt.txt with sandbox environment description for Claude.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:21.303974517Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.167072325Z","closed_at":"2026-01-06T19:03:55.352852687Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wx-ded","title":"Simplify image build","description":"Remove squid, iptables, proxy env vars from image.nix","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T20:29:03.547114461Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.155927762Z","closed_at":"2026-01-06T20:30:48.267348004Z","close_reason":"Closed"}
{"id":"wx-dv5","title":"Platform dispatcher (sandbox/default.nix)","description":"Create lib/sandbox/default.nix - dispatch to linux/ or darwin/ based on system platform.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:36.045973984Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.163969939Z","closed_at":"2026-01-06T19:03:55.364346916Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wx-e4r","title":"Add checks output to flake.nix","description":"Update flake.nix to export checks attribute from lib/tests. Enables nix flake check to run all tests.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T19:43:18.113997411Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.160862072Z","closed_at":"2026-01-06T19:46:14.13996915Z","close_reason":"Closed","labels":["phase:tests","task"]}
{"id":"wx-fxl","title":"Update documentation","description":"Update CLAUDE.md and README.md with usage instructions, requirements, and examples.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T18:51:59.00355804Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.169165605Z","closed_at":"2026-01-06T19:19:47.134316337Z","close_reason":"Documentation updated with profiles simplified and ARCHITECTURE.md diagrams fixed","labels":["phase:3-polish"]}
{"id":"wx-gh2","title":"Blocklist (blocklist.nix)","description":"Create lib/sandbox/blocklist.nix with blocked domains: pastebin sites, file sharing, URL shorteners, webhook sites, code execution platforms, risky TLDs.","design":"Categories:\n- pastebin_sites: pastebin.com, hastebin.com, paste.ee, dpaste.org, ghostbin.com, privatebin.net, 0bin.net, paste.debian.net, bpaste.net\n- file_sharing: transfer.sh, file.io, tmpfiles.org, gofile.io, pixeldrain.com, catbox.moe, uguu.se, filebin.net, uploadfiles.io\n- url_shorteners: bit.ly, tinyurl.com, t.co, goo.gl, ow.ly, is.gd, buff.ly\n- webhook_sites: webhook.site, requestbin.com, hookbin.com, pipedream.com, beeceptor.com, requestcatcher.com, httpbin.org\n- code_execution: replit.com, glitch.com, codepen.io, jsfiddle.net, codesandbox.io\n- risky_tlds: tk, ml, ga, cf, gq, top, xyz, click, link","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:21.535304706Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.166181927Z","closed_at":"2026-01-06T19:03:55.355793031Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wx-idm","title":"Test Linux profiles","description":"Test all profiles work on Linux: pod starts \u003c2s, init sets iptables and exits, Claude container has no caps, UID mapping works.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T18:51:36.322044263Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.169861446Z","closed_at":"2026-01-06T19:24:22.306909599Z","close_reason":"Fixed docker-archive prefix issue, both base and rust profiles build and generate correct podman scripts","labels":["phase:1-core"]}
{"id":"wx-iye","title":"Linux pod orchestration (linux/default.nix)","description":"Create lib/sandbox/linux/default.nix - Podman pod script with 3-container pattern: init (NET_ADMIN, exits), squid (sidecar), claude (unprivileged, interactive).","design":"```bash\nPOD_NAME=\"wrapix-$$\"\ntrap 'podman pod rm -f \"$POD_NAME\"' EXIT SIGINT SIGTERM\n\n# Create pod with isolated network\npodman pod create --name \"$POD_NAME\" --network=slirp4netns\n\n# Init container: set up iptables, exit\npodman run --rm --pod \"$POD_NAME\" --cap-add=NET_ADMIN $INIT_IMAGE\n\n# Squid sidecar: blocklist filtering\npodman run --detach --pod \"$POD_NAME\" --name \"${POD_NAME}-squid\" \\\n  $PROFILE_IMAGE squid -f /etc/squid/squid.conf -N\n\n# Wait for Squid\nwhile ! podman exec \"${POD_NAME}-squid\" squid -k check; do sleep 0.1; done\n\n# Claude container: completely unprivileged\nexec podman run --rm -it --pod \"$POD_NAME\" --userns=keep-id \\\n  -v \"$PROJECT_DIR:/workspace:rw\" \\\n  $PROFILE_IMAGE claude\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:35.955747149Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.164342793Z","closed_at":"2026-01-06T19:03:55.362904644Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wx-j4o","title":"Fix --userns/--pod conflict in Linux sandbox","description":"Move --userns=keep-id from podman run (line 40) to podman pod create (line 24) in lib/sandbox/linux/default.nix. Recent Podman versions don't allow --userns and --pod together on run.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T19:43:17.938168412Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.158492356Z","closed_at":"2026-01-06T19:44:29.895443185Z","close_reason":"Closed","labels":["bug","phase:fix"]}
{"id":"wx-ma9","title":"Delete network filtering files","description":"Delete squid.nix, blocklist.nix, init-image.nix, hook.nix","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T20:29:03.355223356Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.157380351Z","closed_at":"2026-01-06T20:29:30.594266264Z","close_reason":"Closed"}
{"id":"wx-mnf","title":"Profile definitions (profiles.nix)","description":"Create lib/sandbox/profiles.nix with profile definitions: base, rust, go, python, js, nix, devops. Include mount format with source/dest/mode/optional.","design":"Profile structure:\n```nix\n{\n  name = \"rust\";\n  packages = with pkgs; [ rustc cargo rust-analyzer ];\n  mounts = [\n    { source = \"~/.cargo/registry\"; dest = \"~/.cargo/registry\"; mode = \"ro\"; optional = true; }\n  ];\n  env = { CARGO_HOME = \"/tmp/cargo\"; };\n  customPrompt = \"...\";  # optional\n}\n```\n\nProfiles: base, rust, go, python, js, nix, devops\n\nBase packages (all profiles):\nbash coreutils findutils git jujutsu ripgrep fd tree less gnugrep gnused gawk jq yq gnutar gzip zip unzip vim man file which patch diffutils procps rsync\n\nRequired mounts: ~/.claude (rw), ~/.claude.json (rw), ~/.config/git (ro), project dir (rw)\n\nEnv vars: CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1, DISABLE_AUTOUPDATER=1, DISABLE_ERROR_REPORTING=1, DISABLE_TELEMETRY=1","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:21.43574195Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.166625121Z","closed_at":"2026-01-06T19:03:55.354404718Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wx-nk4","title":"Create OCI hook for iptables setup","description":"Create lib/sandbox/linux/hook.nix with iptables hook script and JSON config. Hook runs in container namespace with NET_ADMIN before capabilities are dropped.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T19:59:50.319319354Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.158099121Z","closed_at":"2026-01-06T20:00:26.814009126Z","close_reason":"Closed","labels":["phase:hooks","task"]}
{"id":"wx-p5m","title":"Library exports (lib/default.nix)","description":"Create lib/default.nix exporting: mkSandbox, mkDevShell, deriveProfile, profiles.","design":"```nix\n{ pkgs, system }:\nlet\n  sandbox = import ./sandbox { inherit pkgs system; };\n  profiles = import ./sandbox/profiles.nix { inherit pkgs; };\nin {\n  mkSandbox = profile: sandbox.mkSandbox profile;\n\n  deriveProfile = baseProfile: extensions:\n    baseProfile // extensions // {\n      packages = (baseProfile.packages or []) ++ (extensions.packages or []);\n      mounts = (baseProfile.mounts or []) ++ (extensions.mounts or []);\n      env = (baseProfile.env or {}) // (extensions.env or {});\n    };\n\n  mkDevShell = { packages ? [], shellHook ? \"\" }:\n    pkgs.mkShell { inherit packages shellHook; };\n\n  inherit profiles;\n}\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:36.134120722Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.163601464Z","closed_at":"2026-01-06T19:03:55.366211793Z","close_reason":"Closed","labels":["phase:1-core"]}
{"id":"wx-v65","title":"Simplify init container image","description":"Update lib/sandbox/linux/init-image.nix: remove iptables logic (now handled by hook), make minimal container that just triggers hook and exits.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T19:59:50.491565889Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.160504967Z","closed_at":"2026-01-06T20:01:15.58930236Z","close_reason":"Closed","labels":["phase:hooks","task"]}
{"id":"wx-y45","title":"Clean up smoke tests","description":"Remove blocklist and squid-config tests from smoke.nix","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T20:29:03.74952052Z","created_by":"shaun","updated_at":"2026-01-06T21:15:55.159509011Z","closed_at":"2026-01-06T20:31:46.285143531Z","close_reason":"Closed"}
