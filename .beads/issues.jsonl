{"id":"wx-0nk","title":"Fix deploy_keys SSH configuration","description":"Git push fails: Identity file /home/shaun/.ssh/deploy_keys/ not accessible. Check git config for SSH command overrides and verify deploy key setup in sandbox environment.","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-10T19:23:53.958798516Z","created_by":"Wrapix Sandbox","updated_at":"2026-01-10T19:33:21.83739459Z","closed_at":"2026-01-10T19:33:21.83739459Z","close_reason":"Closed"}
{"id":"wx-0u2","title":"Network security verification","description":"Verify network filtering on both platforms: blocked domains return 403, TLD blocking works, raw IP blocked, WebSocket blocked, DNS exfil blocked, ICMP blocked.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T18:51:59.155250789Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.829591463Z","closed_at":"2026-01-06T19:24:22.322213481Z","close_reason":"Verified: blocklist covers paste/file-sharing/webhooks, TLD blocking, raw IP blocking, WebSocket blocking, DNS/ICMP blocked via iptables"}
{"id":"wx-0ym","title":"Consolidate mkMountSpecs with platform flag","description":"mkMountSpecs function is nearly identical between Linux (lib/sandbox/linux/default.nix:34-43) and Darwin (lib/sandbox/darwin/default.nix:25-34) but Linux includes mode field (VirtioFS doesn't support modes). Create single function with includeMode parameter.","status":"closed","priority":2,"issue_type":"task","owner":"sandbox@wrapix.dev","created_at":"2026-01-12T18:24:09.618373633Z","created_by":"unknown","updated_at":"2026-01-12T19:12:54.939365733Z","closed_at":"2026-01-12T18:56:23.112306144Z"}
{"id":"wx-1ls","title":"Update ARCHITECTURE.md","description":"Update to reflect simplified single-container architecture","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T20:29:03.845256801Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.830675126Z","closed_at":"2026-01-06T20:32:19.844438723Z","close_reason":"Closed"}
{"id":"wx-2mq","title":"Add smoke tests for image builds and configs","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T19:43:18.032875676Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.831346126Z","closed_at":"2026-01-06T19:45:26.61126564Z","close_reason":"Closed"}
{"id":"wx-2nt","title":"Performance tuning","description":"Optimize layer ordering in OCI images, tune VM resources for macOS, verify startup times.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T18:51:59.079598322Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.831022091Z","closed_at":"2026-01-06T19:24:22.33572Z","close_reason":"Added VM CPU/memory tuning options, documented layer ordering strategy for cache efficiency"}
{"id":"wx-2ou","title":"Update ARCHITECTURE.md with gvproxy networking design","description":"Update ARCHITECTURE.md to document gvproxy vsock networking design.\n\n## Content to add:\n1. Diagram showing gvproxy \u003c-\u003e vsock \u003c-\u003e guest networking\n2. Explain why VZNATNetworkDeviceAttachment doesn't work (ICMP-only bug)\n3. Document gvproxy as userspace network stack alternative\n4. Compare with Linux sandbox (pasta) approach\n\n## Files:\n- ARCHITECTURE.md\n\n## Depends on:\n- wx-de3 (implementation)\n- wx-3nl (guest config)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-08T23:02:23.114976Z","updated_at":"2026-01-09T00:55:00.357847597Z","closed_at":"2026-01-09T00:55:00.357847597Z","close_reason":"Closed"}
{"id":"wx-327","title":"Squid configuration (squid.nix)","description":"Create lib/sandbox/squid.nix to generate Squid transparent proxy config with blocklist ACLs, JSON logging, WebSocket blocking.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:21.618257196Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.834591158Z","closed_at":"2026-01-06T19:03:55.357198024Z","close_reason":"Closed"}
{"id":"wx-3nl","title":"Configure guest-side vsock networking in entrypoint.sh","description":"Configure guest-side networking to use vsock connection to gvproxy.\n\n## Changes required:\n1. Add vm_gvproxy or equivalent setup in entrypoint.sh\n2. Configure network interface via vsock instead of virtio-net\n3. Set up DNS resolution through gvproxy\n\n## Files:\n- lib/sandbox/darwin/entrypoint.sh\n\n## Depends on:\n- wx-de3 (host-side gvproxy integration)\n\n## Reference:\n- Lima VM guest agent networking setup\n- gvisor-tap-vsock guest configuration","notes":"Not needed: Using VZFileHandleNetworkDeviceAttachment with gvproxy --listen-vfkit bridges directly to virtio-net. Guest sees standard network interface, configured automatically by vminitd.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-08T23:02:23.070859Z","updated_at":"2026-01-08T23:16:12.479056Z","closed_at":"2026-01-08T23:16:12.47906Z","dependencies":[{"issue_id":"wx-3nl","depends_on_id":"wx-de3","type":"blocks","created_at":"2026-01-08T23:03:42.533937Z","created_by":"shaun"}]}
{"id":"wx-3xn","title":"Add shellcheck and statix to CI lint checks","description":"Shell scripts lack automated linting, and statix is only available in dev shell, not in CI checks.\n\n**Missing checks:**\n1. shellcheck for 5+ shell scripts in repo\n2. statix for Nix code quality (available in devshell but not in checks)\n\n**Shell scripts needing linting:**\n- lib/sandbox/linux/entrypoint.sh\n- lib/sandbox/darwin/entrypoint.sh\n- lib/tests/darwin-mount-test.sh\n- lib/tests/darwin-network-test.sh\n- scripts/setup-tailscale-routing.sh\n- scripts/setup-deploy-key\n\n**Fix:** Add shellcheck and statix checks to lib/tests/lint.nix.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-01-10T19:51:03.210387577Z","created_by":"Wrapix Sandbox","updated_at":"2026-01-10T22:04:31.239050172Z","closed_at":"2026-01-10T22:04:31.239050172Z","close_reason":"Re-closing after container restart"}
{"id":"wx-40g","title":"Add aarch64-darwin to flake","description":"Update flake.nix to add aarch64-darwin support alongside Linux systems.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:50.92957044Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.834226643Z","closed_at":"2026-01-06T19:19:42.978406916Z","close_reason":"aarch64-darwin already in flake.nix from initial implementation"}
{"id":"wx-4ra","title":"Update sandbox prompt","description":"Remove network filtering messaging, reflect container-only isolation","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T20:29:03.649239687Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.831691651Z","closed_at":"2026-01-06T20:31:10.058587745Z","close_reason":"Closed"}
{"id":"wx-4uo","title":"Document magic numbers with named constants","description":"Several magic numbers appear throughout the code without explanation.\n\n**Locations:**\n- lib/tests/integration.nix:25-26 - memorySize = 2048; diskSize = 4096;\n- lib/sandbox/image.nix:65 - maxLayers = 100;\n- lib/sandbox/darwin/default.nix:219 - -m 4G (memory limit)\n- lib/sandbox/darwin/default.nix:73 - sleep 2 (arbitrary wait time)\n\n**Impact:** Hard to understand why these specific values were chosen and maintain them consistently.\n\n**Fix:** Add comments explaining the rationale, or extract to named constants where appropriate.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-10T19:51:37.829521806Z","created_by":"Wrapix Sandbox","updated_at":"2026-01-10T22:04:31.24653875Z","closed_at":"2026-01-10T22:04:31.24653875Z","close_reason":"Re-closing after container restart"}
{"id":"wx-4xz","title":"Test OCI hooks integration","description":"Verify: hook installs correctly, iptables rules applied, blocked domains fail, allowed domains work, file ownership correct in /workspace.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T19:59:50.580073756Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.832135805Z","closed_at":"2026-01-06T20:28:38.786515273Z","close_reason":"No longer needed - removing network filtering entirely"}
{"id":"wx-53r","title":"Fix deploy key lookup - host key verification still failing","description":"The commit d1b85b3 updated deploy key lookup to use repo-hostname format, but SSH still fails with 'Host key verification failed' in the sandbox.\n\n## Symptoms\n- git push fails with 'Host key verification failed'\n- bd sync fails for same reason\n- Deploy key setup appears to have worked but SSH cannot connect\n\n## Likely causes\n1. SSH known_hosts not configured for github.com\n2. Deploy key path still not found correctly\n3. SSH config not pointing to the deploy key\n\n## Files to check\n- lib/sandbox/darwin/default.nix\n- lib/sandbox/linux/default.nix\n- scripts/setup-deploy-key.sh\n- SSH config in container\n\n## To reproduce\n1. Run wrapix sandbox\n2. Try git push or bd sync\n3. Observe 'Host key verification failed'","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-09T01:19:28.477316297Z","created_by":"shaun","updated_at":"2026-01-09T19:25:47.719737503Z","closed_at":"2026-01-09T19:25:47.650768878Z"}
{"id":"wx-582","title":"Linux Claude entrypoint (linux/entrypoint.nix)","description":"Create lib/sandbox/linux/entrypoint.nix - entrypoint script for Claude container with proper environment setup.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:35.870389297Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.834958242Z","closed_at":"2026-01-06T19:03:55.361436072Z","close_reason":"Closed"}
{"id":"wx-583","title":"Run NixOS VM integration tests on machine with Nix","description":"Run `nix flake check` to execute the new NixOS VM integration tests (container-start, filesystem-isolation, user-namespace) on a machine with Nix and KVM support. Verify all tests pass.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T21:12:33.471984848Z","created_by":"Shaun","updated_at":"2026-01-10T15:10:28.502361315Z","closed_at":"2026-01-10T15:10:28.502361315Z","close_reason":"All NixOS VM integration tests pass with 'nix flake check' on this machine","dependencies":[{"issue_id":"wx-583","depends_on_id":"wx-c0h","type":"blocks","created_at":"2026-01-07T15:30:05.979725Z","created_by":"shaun"}]}
{"id":"wx-584","title":"Investigate bd daemon sharing between sandbox and host","description":"Running bd with --sandbox flag in the container causes issues with the host's bd daemon. Host bd commands start timing out and falling back to direct mode. Need to investigate:\n- Whether sandbox and host should share the same .beads directory\n- If daemon socket conflicts are causing the issue\n- Best practices for bd in containerized environments\n- Whether the sandbox should have its own isolated .beads or mount the host's","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T21:12:34.583879527Z","created_by":"Shaun","updated_at":"2026-01-06T21:21:39.098454814Z","closed_at":"2026-01-06T21:21:39.098454814Z","close_reason":"Closed"}
{"id":"wx-5b2","title":"Test Darwin build with Determinate Nix native-linux-builder","description":"**Original plan**: Use Determinate Nix native-linux-builder.\n\n**Updated plan**: Not using Determinate Nix. Instead, use darwin.linux-builder (nixpkgs) or NixOS podman machine (see wx-c0h).\n\nSteps:\n1. Build wrapix: nix build .#wrapix\n2. Test on macOS 26+\n3. Verify Swift CLI runtime build\n\nDepends on having a working linux builder (wx-c0h or alternative).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T00:11:42.867092Z","created_by":"shaun","updated_at":"2026-01-10T11:31:42.002880795Z","closed_at":"2026-01-07T19:29:59.958066Z","dependencies":[{"issue_id":"wx-5b2","depends_on_id":"wx-c0h","type":"blocks","created_at":"2026-01-07T15:29:50.810507Z","created_by":"shaun"}]}
{"id":"wx-6cg","title":"Claude Code npm package (claude-package.nix)","description":"Create lib/sandbox/claude-package.nix to fetch and install Claude Code from npm registry. Pin version, create wrapper script.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:21.188417376Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.83247063Z","closed_at":"2026-01-06T19:03:55.276339569Z","close_reason":"Closed"}
{"id":"wx-6oy","title":"Replace eval with safer path expansion in mount processing","description":"Multiple uses of eval for path expansion in mount processing could be vulnerable to command injection.\n\n**Locations:**\n- lib/sandbox/linux/default.nix:91-92\n- lib/sandbox/darwin/default.nix:129-130  \n- lib/sandbox/darwin/entrypoint.sh:23,38\n\n**Current code:**\n```bash\nsrc=$(eval echo \"$src\")\ndest=$(eval echo \"$dest\")\n```\n\n**Safer alternative:** Use parameter expansion or dedicated path expansion functions instead of eval. Consider using `envsubst` or shell parameter expansion like ${var/#\\~/$HOME}.","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-10T19:50:29.374252552Z","created_by":"Wrapix Sandbox","updated_at":"2026-01-10T21:25:26.30097501Z","closed_at":"2026-01-10T21:02:02.782308227Z"}
{"id":"wx-7a4","title":"macOS Nix wrapper (darwin/default.nix)","description":"Create lib/sandbox/darwin/default.nix - Nix wrapper that invokes the Swift runner with correct paths.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:50.827279116Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.833141Z","closed_at":"2026-01-06T19:19:42.964667828Z","close_reason":"Implemented darwin/default.nix with kernel and Swift CLI integration"}
{"id":"wx-7cb","title":"Verify macOS profiles","description":"Verify all profiles work on macOS: VM boots \u003c1s, virtio-fs mounts work, UID mapping works.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T18:51:51.019001337Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.833465015Z","closed_at":"2026-01-06T19:24:28.244830782Z","close_reason":"Requires macOS hardware to test; implementation complete, needs verification on aarch64-darwin"}
{"id":"wx-7kd","title":"NixOS VM test type check failure","description":"The NixOS integration tests fail type checking:\n\n```\ntestScriptWithTypes:84: error: Incompatible types in assignment (expression has\ntype \"tuple[int, str]\", variable has type \"str\")  [assignment]\n    result = machine.execute(\n             ^\n```\n\nThe `machine.execute()` returns a tuple (exit_code, output) but the test assigns it to a string variable.\n\nThis blocks `nix flake check` from passing.","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-06T21:24:02.295953991Z","created_by":"shaun","updated_at":"2026-01-10T11:31:42.005382592Z","closed_at":"2026-01-07T15:06:45.266078Z"}
{"id":"wx-7sj","title":"Linux init container (linux/init-image.nix)","description":"Create lib/sandbox/linux/init-image.nix - minimal ~5MB image with iptables. Sets up transparent proxy redirect rules, DNS filtering, drops other traffic, then exits.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:35.782245369Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.832820314Z","closed_at":"2026-01-06T19:03:55.360004649Z","close_reason":"Closed"}
{"id":"wx-89c","title":"SSH/git push not working in container","description":"## Problem\ngit push fails with \"Permission denied (publickey)\" inside the container, even though SSH access should be available.\n\n## Observed\n```\ngit@github.com: Permission denied (publickey).\nfatal: Could not read from remote repository.\n```\n\n## Expected\nDeploy key or SSH agent forwarding should enable git push from within the container.\n\n## Investigation needed\n- Check if deploy key is mounted correctly\n- Verify SSH agent forwarding works\n- Check GIT_SSH_COMMAND / SSH config","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-11T18:09:58.448742222Z","created_by":"shaun","updated_at":"2026-01-11T19:50:01.162589Z","closed_at":"2026-01-11T19:50:01.162589Z","close_reason":"Fixed path mismatch: WRAPIX_DEPLOY_KEY had literal $USER but file was copied to expanded path"}
{"id":"wx-8cl","title":"Rewrite Linux orchestration for OCI hooks","description":"Update lib/sandbox/linux/default.nix: remove --userns from pod create, add hook installation, use --userns=keep-id on individual containers, add annotation to trigger hook.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T19:59:50.40448523Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.833814529Z","closed_at":"2026-01-06T20:00:48.166542589Z","close_reason":"Closed"}
{"id":"wx-8ox","title":"Add GitHub Actions CI/CD workflow","description":"No CI/CD automation exists for the project.\n\n**Current state:**\n- No .github/workflows/ directory\n- Tests must be run manually via 'nix flake check'\n- No automated testing on PRs/commits\n\n**Recommended workflow:**\n1. Automated 'nix flake check' on all PRs\n2. Multi-platform builds (x86_64-linux, aarch64-linux, aarch64-darwin)\n3. Run nixfmt, shellcheck, statix linting\n4. Cache Nix store for faster builds\n\n**Impact:** Without CI, broken changes can be merged without detection.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-01-10T19:51:49.247594536Z","created_by":"Wrapix Sandbox","updated_at":"2026-01-10T22:04:31.240727726Z","closed_at":"2026-01-10T22:04:31.240727726Z","close_reason":"Re-closing after container restart"}
{"id":"wx-9cc","title":"Fix Darwin container networking with Tailscale exit node","description":"## Problem\n\nContainer networking fails when Tailscale is using an exit node. TCP connections timeout while ICMP (ping) works.\n\n## Root Cause\n\n1. Apple container CLI uses vmnet for networking (192.168.64.0/24 subnet)\n2. When Tailscale exit node is enabled, ALL traffic routes through Tailscale\n3. Container traffic from 192.168.64.x goes to exit node, but exit node can't NAT responses back to that private IP\n4. \"Allow Local Network Access\" in Tailscale only covers physical LAN, not vmnet's virtual network\n\n## Diagnosis Steps Performed\n\n1. Confirmed networking works with Tailscale off\n2. Confirmed ping works but TCP fails with Tailscale on (exit node intercepts TCP)\n3. Confirmed MTU adjustment doesn't help (tried 1220)\n4. Confirmed this is NOT an NSS/DNS issue - added fakeNss, glibc, resolv.conf correctly\n5. Checked Apple container GitHub issues - found #345 (VPN/MTU issues) and #919 (Local Network Privacy)\n\n## Previous Solution (Removed in bcec832)\n\nThe custom Swift runner used gvproxy (gvisor-tap-vsock) for userspace networking:\n- Connected VM to gvproxy via VZFileHandleNetworkDeviceAttachment\n- gvproxy handled NAT in userspace, traffic appeared from host IP\n- Host IP is recognized by Tailscale, so routing worked correctly\n\nThis was removed when migrating to Apple container CLI, which manages vmnet internally and doesn't allow custom network attachments.\n\n## Proposed Solutions\n\n### Option 1: HTTP Proxy on Host (Recommended)\n- Run tinyproxy/mitmproxy on host bound to 192.168.64.1:8080\n- Set HTTP_PROXY/HTTPS_PROXY in container pointing to gateway\n- Traffic: Container → Proxy → Host network (Tailscale) → Exit node → Internet\n- Pros: Simple, works with current architecture\n- Cons: Proxy config needed, some tools don't respect proxy vars\n\n### Option 2: SOCKS Proxy via SSH Tunnel\n- Create SSH tunnel to exit node: ssh -D 1080 exit-node\n- Configure container to use SOCKS proxy\n- Similar to Option 1 but uses SSH instead of HTTP proxy\n\n### Option 3: Revert to Custom Swift Runner\n- Re-add the Swift runner from before bcec832\n- Use gvproxy for networking as before\n- Pros: Transparent networking, no proxy config\n- Cons: Maintains separate code path, more complex\n\n### Option 4: Tailscale Inside Container\n- Run Tailscale daemon inside container\n- Container joins tailnet directly\n- Pros: Full Tailscale features in container\n- Cons: Auth complexity, resource overhead\n\n## Files Changed (Investigation)\n\n- lib/sandbox/image.nix: Added fakeNss, glibc, NSS symlinks, resolv.conf\n- lib/sandbox/darwin/default.nix: Added --dns 1.1.1.1\n- lib/tests/*.nix: Added --dns 1.1.1.1\n\n## Files to Change (Fix)\n\nFor Option 1 (HTTP Proxy):\n- lib/sandbox/darwin/default.nix: Start proxy, add HTTP_PROXY env vars\n- lib/sandbox/darwin/proxy.nix: New file for tinyproxy package/config\n- flake.nix: Add tinyproxy dependency\n\n## Related\n\n- GitHub issue: https://github.com/apple/container/issues/345\n- Commit that removed gvproxy: bcec832","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-09T14:45:36.761979Z","created_by":"shaun","updated_at":"2026-01-09T18:17:49.36647Z","closed_at":"2026-01-09T18:17:49.36647Z","close_reason":"Fixed by disabling 'Allow Local Network Access' in Tailscale settings. When this option is off, vmnet traffic routes correctly through the exit node."}
{"id":"wx-a0u","title":"Update flake.nix for podman","description":"Update flake.nix - replace bubblewrap with podman sandbox, export packages (wrapix, wrapix-rust, wrapix-go, etc.) and lib functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:36.225889602Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.828905223Z","closed_at":"2026-01-06T19:03:55.367935202Z","close_reason":"Closed"}
{"id":"wx-a2p","title":"Add NixOS VM integration tests","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T19:43:18.194015231Z","created_by":"shaun","updated_at":"2026-01-10T15:10:28.433442997Z","closed_at":"2026-01-10T15:10:28.433442997Z","close_reason":"Integration tests already exist in lib/tests/integration.nix (container-start, filesystem-isolation, user-namespace)","dependencies":[{"issue_id":"wx-a2p","depends_on_id":"wx-c0h","type":"blocks","created_at":"2026-01-07T15:30:06.387784Z","created_by":"shaun"}]}
{"id":"wx-a8l","title":"Implement full Darwin support with Containerization framework","description":"The Darwin sandbox currently shows a 'not yet implemented' message. Full support requires:\n\n1. Swift 6.0 in nixpkgs (currently 5.10.1)\n2. Working Darwin-to-Linux cross-compilation for container images\n3. Pre-built kernel or kernel build support on Darwin\n\nThe infrastructure is in place (Swift source, kernel config) but blocked on nixpkgs toolchain support.\n\nRelated files:\n- lib/sandbox/darwin/default.nix\n- lib/sandbox/darwin/kernel.nix\n- lib/sandbox/darwin/swift/","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T23:23:49.726823Z","created_by":"shaun","updated_at":"2026-01-10T15:13:55.484844888Z","closed_at":"2026-01-10T15:13:55.484844888Z","close_reason":"Darwin support is already implemented using Apple's container CLI (see lib/sandbox/darwin/). Requires macOS 26+. The earlier Swift/Containerization.framework approach was replaced (commit bcec832). Swift 6.0 and kernel compilation are no longer blockers."}
{"id":"wx-apl","title":"Add vmnet support for full internet access (requires Apple Developer cert)","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-01-08T22:48:53.866972Z","updated_at":"2026-01-08T23:03:48.490294Z","closed_at":"2026-01-08T23:03:48.490294Z","close_reason":"Split into wx-de3, wx-3nl, wx-2ou"}
{"id":"wx-ayz","title":"Test Nix builds inside container","description":"## Context\nCommit 1ae8835 added includeNixDB=true and sandbox=false to enable Nix builds inside containers.\n\n## Test plan\n1. Rebuild container image with the new changes\n2. Enter container and verify:\n   - `nix flake check` completes successfully (with builds)\n   - `nix build .#somePackage` works\n   - `nix develop` enters a dev shell\n   - Nix can fetch from cache.nixos.org\n\n## Success criteria\n- Nix commands work without errors about missing store paths\n- Builds complete (may take time to fetch deps on first run)\n- No host /nix/store access required","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T18:11:17.188580214Z","created_by":"shaun","updated_at":"2026-01-11T19:23:39.903895Z","closed_at":"2026-01-11T19:23:39.903895Z","close_reason":"Closed"}
{"id":"wx-b59","title":"Simplify Linux orchestration","description":"Single container with direct network (pasta), remove init/squid sidecars","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T20:29:03.450698171Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.827207718Z","closed_at":"2026-01-06T20:30:08.788617169Z","close_reason":"Closed"}
{"id":"wx-c0h","title":"Build NixOS podman machine image using darwin.linux-builder","description":"## Goal\nCreate a NixOS-based podman machine to replace the default Fedora CoreOS machine for native Nix linux-builder support.\n\n## Background\n- Podman machine on macOS uses Apple Hypervisor (vfkit), not QEMU\n- Default podman machine runs Fedora CoreOS\n- We need a NixOS image compatible with vfkit for native Nix builds\n\n## Prerequisites\n- darwin.linux-builder from nixpkgs (QEMU-based, pre-built from cache)\n- Path: /nix/store/smc5avq1kxn465iz27ihs4g2da7lkbhd-create-builder\n\n## Plan\n\n### Phase 1: Bootstrap with darwin.linux-builder\n1. Start the darwin.linux-builder (QEMU VM on port 31022)\n2. Configure as Nix remote builder in /etc/nix/machines\n3. Verify aarch64-linux builds work\n\n### Phase 2: Build NixOS podman-compatible image\n4. Create NixOS configuration for vfkit/Apple Hypervisor:\n   - Use raw-efi disk format\n   - Uncompressed aarch64 kernel (required for Apple VF)\n   - virtio drivers for block, net, console\n   - virtiofs support for host mounts (/Users, /private, /var/folders)\n   - SSH server for remote access\n   - Nix daemon pre-configured\n\n5. Build the image using darwin.linux-builder:\n   ```bash\n   nix build --system aarch64-linux .#nixos-podman-image\n   ```\n\n### Phase 3: Create podman machine with NixOS\n6. Stop existing podman machine: `podman machine stop`\n7. Remove old machine: `podman machine rm podman-machine-default`\n8. Create new machine with NixOS image:\n   ```bash\n   podman machine init --image-path /path/to/nixos.raw nixos-builder\n   ```\n9. Start and configure: `podman machine start nixos-builder`\n\n### Phase 4: Configure as Nix remote builder\n10. Configure SSH access to podman machine\n11. Add to /etc/nix/machines with appropriate settings\n12. Test linux builds work via podman machine\n\n## NixOS Configuration Template\n\n```nix\n{ config, lib, pkgs, modulesPath, ... }:\n{\n  imports = [ (modulesPath + \"/profiles/qemu-guest.nix\") ];\n\n  # Boot configuration for Apple Hypervisor\n  boot = {\n    loader.grub.efiSupport = true;\n    loader.grub.efiInstallAsRemovable = true;\n    loader.grub.device = \"nodev\";\n    initrd.kernelModules = [ \"virtio_pci\" \"virtio_blk\" ];\n    # Uncompressed kernel for Apple VF\n    kernelParams = [ \"console=ttyAMA0,115200n8\" ];\n  };\n\n  # Filesystem layout\n  fileSystems.\"/\" = { device = \"/dev/vda2\"; fsType = \"ext4\"; };\n  fileSystems.\"/boot\" = { device = \"/dev/vda1\"; fsType = \"vfat\"; };\n\n  # Networking\n  networking.hostName = \"nixos-builder\";\n  networking.useDHCP = true;\n\n  # SSH for remote builder access\n  services.openssh.enable = true;\n  services.openssh.settings.PermitRootLogin = \"yes\";\n\n  # Nix daemon configuration\n  nix.settings.trusted-users = [ \"root\" \"@wheel\" ];\n  nix.settings.experimental-features = [ \"nix-command\" \"flakes\" ];\n\n  # User configuration\n  users.users.root.initialPassword = \"nixos\";\n\n  system.stateVersion = \"24.11\";\n}\n```\n\n## Key Considerations\n- Apple Hypervisor requires uncompressed aarch64 kernel\n- virtiofs mounts may need special configuration\n- podman machine expects specific partition layout\n- SSH key exchange needed for remote builder auth\n\n## References\n- darwin.linux-builder: https://ryantm.github.io/nixpkgs/builders/special/darwin-builder/\n- NixOS disk images: https://jade.fyi/blog/nixos-disk-images-m1/\n- nixos-generators: https://github.com/nix-community/nixos-generators","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-07T15:29:09.605628Z","created_by":"shaun","updated_at":"2026-01-07T18:41:34.757697Z","closed_at":"2026-01-07T18:41:34.757697Z","close_reason":"User chose nix-darwin linux-builder (nix.linux-builder.enable = true) instead of building a custom NixOS podman machine"}
{"id":"wx-c6z","title":"Add input validation for environment variables in entrypoints","description":"Entrypoint scripts trust environment variables without validation.\n\n**Locations:**\n- lib/sandbox/darwin/entrypoint.sh:19-30 - Uses WRAPIX_DIR_MOUNTS without validation\n- lib/sandbox/darwin/entrypoint.sh:34-45 - Uses WRAPIX_FILE_MOUNTS without validation\n\n**Risk:** Malformed environment variables could cause unexpected behavior.\n\n**Fix:** Add validation to check format before processing mount specifications.","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-10T19:50:44.866648221Z","created_by":"Wrapix Sandbox","updated_at":"2026-01-10T22:04:31.237276518Z","closed_at":"2026-01-10T22:04:31.237276518Z","close_reason":"Re-closing after container restart"}
{"id":"wx-c7f","title":"Fix Darwin VM file mounts - API key not being read","description":"After implementing the file mount workaround for Darwin VMs (parent directory mounting with copy), Claude still shows 'Invalid API key · Please run /login' on startup. The ~/.claude.json file should be copied from the VirtioFS mount to /home/$USER/.claude.json with correct ownership, but something is still not working. Need to debug the entrypoint to verify the copy is happening correctly.","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-08T13:16:01.104956Z","created_by":"shaun","updated_at":"2026-01-08T14:01:36.970684Z","closed_at":"2026-01-08T14:01:36.970684Z","close_reason":"Closed"}
{"id":"wx-ca5","title":"macOS kernel build (darwin/kernel.nix)","description":"Create lib/sandbox/darwin/kernel.nix - build Linux kernel with Apple Containerization config for arm64, VIRTIO_FS built-in.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:50.670252663Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.828560498Z","closed_at":"2026-01-06T19:19:42.936019079Z","close_reason":"Implemented kernel.nix with comprehensive VirtIO config"}
{"id":"wx-cc4","title":"OCI image builder (image.nix)","description":"Create lib/sandbox/image.nix using dockerTools.buildLayeredImage. Include base packages, profile packages, cacert, macOS entrypoint script.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:21.707590825Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.827885668Z","closed_at":"2026-01-06T19:03:55.358586907Z","close_reason":"Closed"}
{"id":"wx-cga","title":"macOS Swift CLI (darwin/swift/)","description":"Create lib/sandbox/darwin/swift/ with Package.swift and SandboxRunner.swift - VM orchestration using Apple Containerization framework.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:50.745683184Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.828224473Z","closed_at":"2026-01-06T19:19:42.951932515Z","close_reason":"Implemented Swift CLI with SandboxRunner.swift and Package.swift"}
{"id":"wx-cpc","title":"System prompt for sandbox (sandbox-prompt.txt)","description":"Create lib/sandbox/sandbox-prompt.txt with sandbox environment description for Claude.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:21.303974517Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.830321922Z","closed_at":"2026-01-06T19:03:55.352852687Z","close_reason":"Closed"}
{"id":"wx-d8k","title":"Fix Nix store access in Linux sandbox","description":"## Problem\nRunning `nix flake check` in the Linux sandbox fails due to read-only /nix/store.\n\n## Constraints (from ARCHITECTURE.md)\n- No elevated capabilities\n- Must use --userns=keep-id for correct file ownership\n- Container isolation is the security boundary\n\n## What Works\n- Evaluation-only: When /nix/var/nix doesn't exist, Nix falls back to chroot store at ~/.local/share/nix/root (writable under home tmpfs)\n- Shows warning but evaluation succeeds\n- Builds fail because chroot store doesn't have packages from image\n\n## What We Tried\n1. **tmpfs on /nix/var/nix** - Makes Nix try real /nix/store, fails on lock files\n2. **tmpfs on /nix/store/.links** - Doesn't help, lock files are next to store paths\n3. **NIX_STORE_DIR/NIX_STATE_DIR** - Breaks binary cache (paths baked in)\n4. **eval-store config** - Not a valid config option (CLI flag only)\n5. **Kernel overlay mount** - Podman doesn't support type=overlay\n6. **fuse-overlayfs** - fusermount not working in container\n7. **Running as root + setpriv** - UID mapping breaks file access\n\n## Potential Solutions to Investigate\n- https://github.com/chrisguest75/nix-examples - may have container examples\n- nix-user-chroot tool\n- Different podman configuration\n- Nix's read-only=true store option for query-only operations\n- Accept evaluation-only (`nix flake check --no-build`)\n\n## Current State\nSimple setup with:\n- --userns=keep-id\n- --passwd-entry for correct home\n- tmpfs on /home/$USER\n- Chroot store fallback (warning shown, evaluation works)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T14:53:18.821564305Z","created_by":"shaun","updated_at":"2026-01-10T15:12:53.496467267Z","closed_at":"2026-01-10T15:12:53.496467267Z","close_reason":"Documented Nix evaluation-only mode in sandbox-prompt.txt. Builds are not supported inside the sandbox due to read-only /nix/store - this is expected container isolation behavior. Evaluation commands (nix eval, nix flake show, nix flake check --no-build) work via chroot store fallback."}
{"id":"wx-dbs","title":"Update service log paths to XDG-compliant locations","description":"Log files in scripts/notify/*.service and scripts/tailscale/ are written to /tmp which could be read by other users on multi-user systems. Update to use XDG-compliant paths like $XDG_STATE_HOME/wrapix/ or ~/.local/state/wrapix/","status":"closed","priority":3,"issue_type":"task","owner":"sandbox@wrapix.dev","created_at":"2026-01-12T18:23:40.020823926Z","created_by":"unknown","updated_at":"2026-01-12T19:12:54.941702263Z","closed_at":"2026-01-12T19:01:03.802991536Z"}
{"id":"wx-de3","title":"Implement gvproxy vsock networking in SandboxRunner.swift","description":"Modify SandboxRunner.swift to use gvproxy vsock networking instead of VZNATNetworkDeviceAttachment.\n\n## Changes required:\n1. Add VZVirtioSocketDeviceConfiguration to VM config\n2. Launch gvproxy daemon as subprocess before VM start\n3. Connect vsock to gvproxy Unix socket\n4. Remove VZNATNetworkDeviceAttachment (ICMP-only, broken for TCP/UDP)\n\n## Files:\n- lib/sandbox/darwin/swift/Sources/wrapix-runner/SandboxRunner.swift\n- lib/sandbox/darwin/default.nix (add gvproxy dependency)\n\n## Reference:\n- gvproxy package: lib/sandbox/darwin/gvproxy.nix (already built)\n- Lima VM implementation for vsock networking pattern\n- vfkit: https://github.com/crc-org/vfkit","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-08T23:02:23.02784Z","updated_at":"2026-01-08T23:16:16.315371Z","closed_at":"2026-01-08T23:16:16.315371Z","close_reason":"Closed"}
{"id":"wx-ded","title":"Simplify image build","description":"Remove squid, iptables, proxy env vars from image.nix","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T20:29:03.547114461Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.825880838Z","closed_at":"2026-01-06T20:30:48.267348004Z","close_reason":"Closed"}
{"id":"wx-dv5","title":"Platform dispatcher (sandbox/default.nix)","description":"Create lib/sandbox/default.nix - dispatch to linux/ or darwin/ based on system platform.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:36.045973984Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.823386166Z","closed_at":"2026-01-06T19:03:55.364346916Z","close_reason":"Closed"}
{"id":"wx-e4r","title":"Add checks output to flake.nix","description":"Update flake.nix to export checks attribute from lib/tests. Enables nix flake check to run all tests.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T19:43:18.113997411Z","created_by":"shaun","updated_at":"2026-01-06T19:46:14.13996915Z","closed_at":"2026-01-06T19:46:14.13996915Z","close_reason":"Closed"}
{"id":"wx-fh6","title":"Harmonize system prompt paths between Linux and Darwin","description":"System prompt path differs between Linux and Darwin without clear reason.\n\n**Locations:**\n- lib/sandbox/linux/entrypoint.sh:30 - Uses /etc/wrapix-prompt\n- lib/sandbox/darwin/entrypoint.sh:84 - Uses /etc/wrapix/wrapix-prompt\n\n**Impact:** Confusing inconsistency between platforms.\n\n**Fix:** Use consistent path on both platforms (e.g., /etc/wrapix/prompt or /etc/wrapix-prompt).","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-10T19:51:18.481060641Z","created_by":"Wrapix Sandbox","updated_at":"2026-01-10T22:04:31.244032587Z","closed_at":"2026-01-10T22:04:31.244032587Z","close_reason":"Re-closing after container restart"}
{"id":"wx-fxl","title":"Update documentation","description":"Update CLAUDE.md and README.md with usage instructions, requirements, and examples.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T18:51:59.00355804Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.826207403Z","closed_at":"2026-01-06T19:19:47.134316337Z","close_reason":"Documentation updated with profiles simplified and ARCHITECTURE.md diagrams fixed"}
{"id":"wx-g57","title":"Investigate Nix store solutions for container builds","description":"## Problem\n`nix flake check` can evaluate but not build inside the container because:\n1. Container's /nix/store is incomplete (runtime packages only, no build deps like stdenv)\n2. Derivations are evaluated with /nix/store paths that don't exist\n3. --store and NIX_STORE_DIR options don't change paths inside derivations\n\n## Current workaround\n- `nix flake check --no-build --impure` works for evaluation verification\n- Full builds must run outside the container\n\n## Potential solutions to investigate\n1. Nix experimental local-overlay-store feature\n2. Mounting host /nix/var/nix with proper isolation (not full /nix)\n3. Pre-populating container with build dependencies\n4. Using a remote Nix daemon/store\n5. Exploring NIX_REMOTE or other env vars for store redirection\n\n## References\n- https://nix.dev/manual/nix/2.30/store/types/experimental-local-overlay-store\n- The chroot store at ~/.local/share/nix/root works for fetching but not for builds","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-10T22:56:29.445983853Z","created_by":"unknown","updated_at":"2026-01-12T17:55:48.119404458Z","closed_at":"2026-01-11T18:04:58.521205256Z"}
{"id":"wx-gh2","title":"Blocklist (blocklist.nix)","description":"Create lib/sandbox/blocklist.nix with blocked domains: pastebin sites, file sharing, URL shorteners, webhook sites, code execution platforms, risky TLDs.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:21.535304706Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.829246758Z","closed_at":"2026-01-06T19:03:55.355793031Z","close_reason":"Closed"}
{"id":"wx-gxf","title":"Fix unquoted ls output parsing in Darwin entrypoint","description":"In the Darwin entrypoint, ls output is parsed without proper quoting, which could cause issues with special characters.\n\n**Location:** lib/sandbox/darwin/entrypoint.sh:55-56\n\n**Current code:**\n```bash\nif [ -d \"$HOME/.ssh/deploy_keys\" ] \u0026\u0026 [ -n \"$(ls -A $HOME/.ssh/deploy_keys 2\u003e/dev/null)\" ]; then\n  DEPLOY_KEY=$(ls $HOME/.ssh/deploy_keys/* | head -1)\n```\n\n**Issues:**\n- $HOME not quoted inside ls command\n- ls output isn't quoted and could cause issues with spaces in filenames\n- Parsing ls output is generally discouraged\n\n**Fix:** Use find or glob patterns instead of parsing ls output.","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-10T19:51:37.735187525Z","created_by":"Wrapix Sandbox","updated_at":"2026-01-10T22:04:31.239906069Z","closed_at":"2026-01-10T22:04:31.239906069Z","close_reason":"Re-closing after container restart"}
{"id":"wx-idm","title":"Test Linux profiles","description":"Test all profiles work on Linux: pod starts \u003c2s, init sets iptables and exits, Claude container has no caps, UID mapping works.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-06T18:51:36.322044263Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.824124035Z","closed_at":"2026-01-06T19:24:22.306909599Z","close_reason":"Fixed docker-archive prefix issue, both base and rust profiles build and generate correct podman scripts"}
{"id":"wx-irg","title":"Fix beads sync in containers - staging mount breaks git visibility","description":"## Problem\n\nContainer staging mount for .beads isolates the JSONL from git, causing sync issues:\n- Container writes to /workspace/.beads/issues.jsonl (staged copy)\n- Git sees underlying host file (unchanged)\n- bd sync exports correctly but git add picks up stale host file\n\n## Root Cause\n\nLinux/Darwin default.nix mounts entire .beads directory to staging:\n```bash\nBEADS_ARGS=\"-v $BEADS_STAGING:/workspace/.beads\"\n```\n\nThis isolates both beads.db (needed) AND issues.jsonl (breaks sync).\n\n## Proposed Fix\n\nOnly stage the database, mount JSONL directly:\n```bash\nBEADS_ARGS=\"-v $BEADS_STAGING:/workspace/.beads\"\nBEADS_ARGS=\"$BEADS_ARGS -v $PROJECT_DIR/.beads/issues.jsonl:/workspace/.beads/issues.jsonl\"\n```\n\nThis way:\n- beads.db is isolated in staging (SQLite happy)\n- issues.jsonl is shared with host (git sync works)\n\n## Files\n- lib/sandbox/linux/default.nix\n- lib/sandbox/darwin/default.nix","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-10T22:06:06.441741705Z","created_by":"Wrapix Sandbox","updated_at":"2026-01-10T23:01:07.747243757Z","closed_at":"2026-01-10T23:01:07.747243757Z","close_reason":"bd sync works via beads branch - no practical issue"}
{"id":"wx-iye","title":"Linux pod orchestration (linux/default.nix)","description":"Create lib/sandbox/linux/default.nix - Podman pod script with 3-container pattern: init (NET_ADMIN, exits), squid (sidecar), claude (unprivileged, interactive).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:35.955747149Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.829966927Z","closed_at":"2026-01-06T19:03:55.362904644Z","close_reason":"Closed"}
{"id":"wx-j4o","title":"Fix --userns/--pod conflict in Linux sandbox","description":"Move --userns=keep-id from podman run (line 40) to podman pod create (line 24) in lib/sandbox/linux/default.nix. Recent Podman versions don't allow --userns and --pod together on run.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T19:43:17.938168412Z","created_by":"shaun","updated_at":"2026-01-06T19:44:29.895443185Z","closed_at":"2026-01-06T19:44:29.895443185Z","close_reason":"Closed"}
{"id":"wx-j6m","title":"Fix inconsistent error handling in shell scripts","description":"Shell scripts use inconsistent error handling - some use 'set -e', others use 'set -euo pipefail'.\n\n**Locations:**\n- lib/sandbox/linux/entrypoint.sh:2 - Uses 'set -euo pipefail' ✓\n- lib/sandbox/darwin/entrypoint.sh:2 - Uses 'set -euo pipefail' ✓\n- lib/tests/darwin-mount-test.sh:6 - Uses only 'set -e' ✗\n- lib/tests/darwin-network-test.sh:4 - Uses only 'set -e' ✗\n\n**Impact:** Tests might not fail on undefined variables or pipe failures.\n\n**Fix:** All scripts should use 'set -euo pipefail' for strictest error handling.","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-10T19:50:29.576755024Z","created_by":"Wrapix Sandbox","updated_at":"2026-01-10T22:04:31.236278383Z","closed_at":"2026-01-10T22:04:31.236278383Z","close_reason":"Re-closing after container restart"}
{"id":"wx-j7d","title":"Replace sed YAML parsing with yq for beads config","description":"Both entrypoint scripts parse YAML config using sed regex, which is fragile.\n\n**Locations:**\n- lib/sandbox/linux/entrypoint.sh:24\n- lib/sandbox/darwin/entrypoint.sh:77\n\n**Current code:**\n```bash\nPREFIX=$(grep 'issue-prefix:' /workspace/.beads/config.yaml | sed 's/.*\"\\([^\"]*\\)\".*/\\1/' || echo \"\")\n```\n\n**Issues:**\n- Assumes specific YAML formatting (quotes around value)\n- Doesn't handle edge cases (multiple matches, malformed YAML)\n- Could fail silently and default to empty string\n\n**Fix:** Use yq which is already in the base packages.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T19:51:03.114936158Z","created_by":"Wrapix Sandbox","updated_at":"2026-01-10T22:04:31.238188834Z","closed_at":"2026-01-10T22:04:31.238188834Z","close_reason":"Re-closing after container restart"}
{"id":"wx-jf5","title":"Extract shared path expansion functions to lib/sandbox/paths.nix","description":"expandPath and expandDest functions are duplicated between lib/sandbox/linux/default.nix:17-30 and lib/sandbox/darwin/default.nix:8-21. Create lib/sandbox/paths.nix with shared implementations to reduce duplication.","status":"closed","priority":2,"issue_type":"task","owner":"sandbox@wrapix.dev","created_at":"2026-01-12T18:24:09.371503531Z","created_by":"unknown","updated_at":"2026-01-12T19:12:54.942433233Z","closed_at":"2026-01-12T18:33:05.439796131Z"}
{"id":"wx-k8m","title":"Fix etc/gitconfig permission error in wrapix-base-customisation-layer","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-07T19:30:00.26663Z","created_by":"shaun","updated_at":"2026-01-07T19:42:42.649184Z","closed_at":"2026-01-07T19:42:42.649184Z","close_reason":"Fixed by moving gitconfig to separate derivation (writeTextDir) instead of creating in extraCommands where etc/ was already read-only from other packages"}
{"id":"wx-kvu","title":"Create setup-claude-auth.sh script for OAuth token extraction","description":"Claude Code stores OAuth tokens in macOS Keychain, which is not accessible from the Linux VM. This causes 'Missing API key' error.\n\nSolution: Create scripts/setup-claude-auth.sh that:\n1. Extracts OAuth token from Keychain ('Claude Code-credentials')\n2. Adds it to ~/.claude.json as oauthAccount.accessToken\n3. User runs once after Claude login, then wrapix works\n\nSee plan: ~/.claude/plans/sunny-hugging-wind.md","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-08T19:33:09.821706Z","created_by":"shaun","updated_at":"2026-01-08T19:46:56.092Z","closed_at":"2026-01-08T19:46:56.092Z","close_reason":"Closed"}
{"id":"wx-l54","title":"Fix beads database detection inside container","description":"bd commands fail with 'database not initialized: issue_prefix config is missing' even though .beads/config.yaml exists with issue-prefix set. Requires explicit BD_DB=/workspace/.beads/beads.db to work. Likely an issue with database path resolution or daemon socket communication in the sandbox environment.","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-10T19:24:19.684573163Z","created_by":"Wrapix Sandbox","updated_at":"2026-01-10T19:28:18.794826492Z","closed_at":"2026-01-10T19:28:18.794826492Z","close_reason":"Fixed: entrypoints now initialize container-local database from workspace JSONL on startup. Provides isolation for concurrent agents while maintaining sync via JSONL."}
{"id":"wx-lzf","title":"Document skopeo --insecure-policy rationale","description":"In lib/sandbox/darwin/default.nix:91, skopeo is called with --insecure-policy which bypasses signature verification. This is acceptable because images are built locally from Nix derivations (trusted source). Add a comment documenting this decision for future maintainers.","status":"closed","priority":3,"issue_type":"task","owner":"sandbox@wrapix.dev","created_at":"2026-01-12T18:24:09.25268991Z","created_by":"unknown","updated_at":"2026-01-12T19:12:54.943176224Z","closed_at":"2026-01-12T19:03:38.709941618Z"}
{"id":"wx-ma9","title":"Delete network filtering files","description":"Delete squid.nix, blocklist.nix, init-image.nix, hook.nix","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T20:29:03.355223356Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.823800309Z","closed_at":"2026-01-06T20:29:30.594266264Z","close_reason":"Closed"}
{"id":"wx-mnf","title":"Profile definitions (profiles.nix)","description":"Create lib/sandbox/profiles.nix with profile definitions: base, rust, go, python, js, nix, devops. Include mount format with source/dest/mode/optional.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:21.43574195Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.827537643Z","closed_at":"2026-01-06T19:03:55.354404718Z","close_reason":"Closed"}
{"id":"wx-mr3","title":"Fix beads-viewer dependency breaking dev shell","description":"The beads-viewer dependency fails to build, breaking 'nix develop'.\n\n**Error:**\n```\nerror: Cannot build '/nix/store/...-bv-0.11.3-go-modules.drv'\nbash: /nix/store/...-source-stdenv.sh: No such file or directory\n```\n\n**Impact:** Developers cannot access the dev shell with statix linter and other tools.\n\n**Fix options:**\n1. Update beads-viewer to a working version\n2. Make beads-viewer optional in the dev shell\n3. Fix the Go modules derivation","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-10T19:51:49.342763483Z","created_by":"Wrapix Sandbox","updated_at":"2026-01-10T22:04:31.241550244Z","closed_at":"2026-01-10T22:04:31.241550244Z","close_reason":"Re-closing after container restart"}
{"id":"wx-nk4","title":"Create OCI hook for iptables setup","description":"Create lib/sandbox/linux/hook.nix with iptables hook script and JSON config. Hook runs in container namespace with NET_ADMIN before capabilities are dropped.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-06T19:59:50.319319354Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.82445245Z","closed_at":"2026-01-06T20:00:26.814009126Z","close_reason":"Closed"}
{"id":"wx-o4q","title":"Fix README documentation mismatch - jujutsu not in packages","description":"README.md lists 'jujutsu' in the base profile packages, but it's not actually included.\n\n**Locations:**\n- README.md:28 - Lists jujutsu as included\n- lib/sandbox/profiles.nix:5-38 - No jujutsu package present\n\n**Impact:** Users may expect jujutsu to be available but it won't be installed.\n\n**Fix:** Either add jujutsu to base profile packages or remove it from README.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-10T19:50:59.992553877Z","created_by":"Wrapix Sandbox","updated_at":"2026-01-10T22:04:31.243228289Z","closed_at":"2026-01-10T22:04:31.243228289Z","close_reason":"Re-closing after container restart"}
{"id":"wx-p5m","title":"Library exports (lib/default.nix)","description":"Create lib/default.nix exporting: mkSandbox, mkDevShell, deriveProfile, profiles.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T18:51:36.134120722Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.821317686Z","closed_at":"2026-01-06T19:03:55.366211793Z","close_reason":"Closed"}
{"id":"wx-q6x","title":"Implement container-to-host notification system","description":"## Problem\nClaude Code runs inside containers but needs to trigger native notifications on the host machine (Linux or macOS).\n\n## Solution\nUnix socket + host daemon approach:\n- Host runs `wrapix-notifyd` listening on a Unix socket\n- Socket is mounted into containers\n- Container uses `wrapix-notify` client to send notification requests\n- Daemon triggers native notifications (terminal-notifier on macOS, notify-send on Linux)\n\n## Implementation\nSee plan file: ~/.claude/plans/ethereal-bubbling-hellman.md\n\nFiles to create/modify:\n- lib/notifyd.nix (create) - Host-side notification daemon\n- lib/notify-client.nix (create) - Container-side client\n- lib/sandbox/darwin/default.nix (modify) - Add socket mount\n- lib/sandbox/linux/default.nix (modify) - Add socket mount\n- lib/sandbox/image.nix (modify) - Include notify client\n- flake.nix (modify) - Expose notifyd package","status":"closed","priority":2,"issue_type":"feature","owner":"sandbox@wrapix.dev","created_at":"2026-01-12T00:12:15.548069798Z","created_by":"shaun","updated_at":"2026-01-12T00:44:26.620065Z","closed_at":"2026-01-12T00:30:22.462638553Z"}
{"id":"wx-qge","title":"Add resource limits to Linux containers","description":"Darwin containers have CPU (-c) and memory (-m 4G) limits, but Linux Podman containers have no resource limits configured.\n\n**Location:** lib/sandbox/linux/default.nix:133-147\n\n**Impact:** Container can consume unlimited CPU/memory on Linux host.\n\n**Fix:** Add --memory and --cpus flags to podman run command, similar to Darwin implementation.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-10T19:50:29.47854463Z","created_by":"Wrapix Sandbox","updated_at":"2026-01-10T21:41:24.214854802Z","closed_at":"2026-01-10T21:41:24.214854802Z","close_reason":"test close"}
{"id":"wx-qx3","title":"Reduce excessive use of || true error suppression","description":"Many commands use '|| true' to suppress errors, which could hide real problems.\n\n**High-risk locations:**\n- lib/sandbox/linux/entrypoint.sh:9 - fuse-overlayfs failure could silently break Nix builds\n- lib/sandbox/linux/entrypoint.sh:26 - bd init failure silently ignored\n- lib/sandbox/darwin/entrypoint.sh:79 - bd init failure silently ignored\n\n**Acceptable locations:**\n- lib/sandbox/darwin/default.nix:85 - container image delete (expected to fail if image doesn't exist)\n\n**Impact:** Real failures could be masked, making debugging difficult.\n\n**Fix:** Check specific error conditions rather than blanket suppression, or add logging when suppressing expected errors.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-10T19:51:37.926204582Z","created_by":"Wrapix Sandbox","updated_at":"2026-01-10T22:04:31.247366008Z","closed_at":"2026-01-10T22:04:31.247366008Z","close_reason":"Re-closing after container restart"}
{"id":"wx-r7u","title":"Clean up unused git sshCommand config in image","description":"The gitconfig includes a complex sshCommand setup that's no longer used after commit 23ec318.\n\n**Location:** lib/sandbox/image.nix:24\n\n**Code:**\n```nix\nsshCommand = sh -c '[ -n \"$DEPLOY_KEY_NAME\" ] \u0026\u0026 exec ssh -i \"$HOME/.ssh/deploy_keys/$DEPLOY_KEY_NAME\" -o IdentitiesOnly=yes \"$@\" || exec ssh \"$@\"' --\n```\n\n**Context:** Recent commit 23ec318 switched to GIT_SSH_COMMAND environment variable approach, but the old config remains in the image.\n\n**Fix:** Remove the unused sshCommand from gitconfig or verify it's still needed.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-10T19:51:18.579670292Z","created_by":"Wrapix Sandbox","updated_at":"2026-01-10T22:04:31.244840195Z","closed_at":"2026-01-10T22:04:31.244840195Z","close_reason":"Re-closing after container restart"}
{"id":"wx-rfr","title":"Fix ~/.claude.json and ~/.claude/ mounts in Darwin VM","description":"## Problem\nVirtioFS (Apple's Virtualization framework) only supports directory mounts via VZSingleDirectoryShare. The Swift runner explicitly skips file mounts (SandboxRunner.swift:150-152). This means:\n- ~/.claude/ (directory) - works\n- ~/.claude.json (file) - silently skipped\n- ~/.claude.json.backup (file) - silently skipped\n\n## Solution: Parent Directory Mounts with Symlinks\nFor file mounts, mount the parent directory to a hidden location, then symlink the specific file to its expected destination.\n\n## Files to Modify\n1. lib/sandbox/darwin/default.nix - Separate file vs directory mounts, add --file-mount args\n2. lib/sandbox/darwin/swift/Sources/wrapix-runner/SandboxRunner.swift - Handle file mounts by mounting parent dirs to /mnt/wrapix/fm/\u003cn\u003e/, pass WRAPIX_FILE_MOUNTS env var\n3. lib/sandbox/image.nix - Update entrypoint to parse WRAPIX_FILE_MOUNTS and create symlinks\n\n## Edge Cases\n- Optional mounts: Check file existence at runtime before adding to args\n- Multiple files from same parent: Each gets its own mount (simple, small overhead)\n- File permissions: Symlinks preserve original file permissions through virtiofs","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-08T11:06:33.383015Z","created_by":"shaun","updated_at":"2026-01-08T12:57:58.521769Z","closed_at":"2026-01-08T12:57:58.521769Z","close_reason":"Fixed VirtioFS file mounts by: 1) Adding --file-mount CLI option to Swift runner that mounts parent directories, 2) Passing file mappings via WRAPIX_FILE_MOUNTS env var, 3) Entrypoint copies files with correct ownership (fixing VirtioFS root permission issue), 4) Using eval to expand $USER in destination paths"}
{"id":"wx-uzi","title":"Add proper error handling to Swift runner","description":"SandboxRunner.swift silently skips invalid mounts with `continue`. Should log warnings or errors for:\n- Invalid mount format (missing `:`)\n- Non-existent source paths (for non-optional mounts)\n- Permission errors\n\nLocation: lib/sandbox/darwin/swift/Sources/wrapix-runner/SandboxRunner.swift lines 145-157","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-08T11:51:00.91299Z","created_by":"shaun","updated_at":"2026-01-09T14:50:27.343378Z","closed_at":"2026-01-09T14:50:27.343378Z","close_reason":"Swift runner removed in bcec832 - migrated to Apple container CLI"}
{"id":"wx-v65","title":"Simplify init container image","description":"Update lib/sandbox/linux/init-image.nix: remove iptables logic (now handled by hook), make minimal container that just triggers hook and exits.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T19:59:50.491565889Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.826545558Z","closed_at":"2026-01-06T20:01:15.58930236Z","close_reason":"Closed"}
{"id":"wx-wr9","title":"Remove unused customPrompt feature from profile system","description":"The customPrompt parameter is defined in the profile system but never used anywhere in the codebase.\n\n**Locations:**\n- lib/sandbox/profiles.nix:77 - Accepts customPrompt parameter\n- lib/sandbox/profiles.nix:85 - Conditionally includes it in profile\n\n**Impact:** Dead code that adds complexity without providing functionality. The system prompt is hardcoded to use /etc/wrapix-prompt (Linux) or /etc/wrapix/wrapix-prompt (Darwin).\n\n**Fix:** Remove the customPrompt parameter and related code, or implement the feature if intended.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-10T19:50:44.963932126Z","created_by":"Wrapix Sandbox","updated_at":"2026-01-10T22:04:31.242416981Z","closed_at":"2026-01-10T22:04:31.242416981Z","close_reason":"Re-closing after container restart"}
{"id":"wx-xfa","title":"Enable Nix builds in sandbox via fuse-overlayfs","description":"## Problem\nThe Linux sandbox has a read-only /nix/store from the container image. While Nix evaluation works via chroot store fallback, builds fail.\n\n## Solution\nUse fuse-overlayfs to create a writable overlay on /nix/store:\n1. Add --device /dev/fuse to podman run command\n2. Include fuse-overlayfs in container image\n3. Mount overlay in entrypoint: lower=/nix/store, upper=tmpfs\n\n## References\n- [fuse-overlayfs](https://github.com/containers/fuse-overlayfs)\n- [Nix experimental local-overlay-store](https://nix.dev/manual/nix/2.22/store/types/experimental-local-overlay-store)\n- [Podman rootless overlay support](https://www.redhat.com/en/blog/podman-rootless-overlay)\n\n## Constraints\n- Must work rootless (--userns=keep-id)\n- No elevated capabilities\n- Container isolation remains the security boundary","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T15:17:20.748209018Z","created_by":"shaun","updated_at":"2026-01-10T15:21:23.18322291Z","closed_at":"2026-01-10T15:21:23.18322291Z","close_reason":"Implemented fuse-overlayfs solution: added fuse-overlayfs to profiles.nix, --device /dev/fuse to podman run, overlay mount in entrypoint.sh. All tests pass."}
{"id":"wx-y45","title":"Clean up smoke tests","description":"Remove blocklist and squid-config tests from smoke.nix","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-06T20:29:03.74952052Z","created_by":"shaun","updated_at":"2026-01-07T12:57:43.825525064Z","closed_at":"2026-01-06T20:31:46.285143531Z","close_reason":"Closed"}
{"id":"wx-yjs","title":"Extract shared shell functions to sourced library","description":"Both entrypoint scripts and sandbox launchers duplicate: expand_path() shell function, stale staging directory cleanup logic, and deploy key path generation. Create lib/sandbox/shell-lib.sh with shared functions that can be sourced by both platforms.","status":"closed","priority":2,"issue_type":"task","owner":"sandbox@wrapix.dev","created_at":"2026-01-12T18:24:09.49706391Z","created_by":"unknown","updated_at":"2026-01-12T19:12:54.943898255Z","closed_at":"2026-01-12T18:49:38.313251526Z"}
{"id":"wx-yw1","title":"Fix JSON injection in notification client","description":"The notification client in lib/notify/client.nix uses printf with %s for JSON construction. If title/message contains quotes, backslashes, or newlines, JSON becomes malformed. Fix by using jq for safe JSON construction instead of printf.","status":"closed","priority":1,"issue_type":"bug","owner":"sandbox@wrapix.dev","created_at":"2026-01-12T18:23:39.790493794Z","created_by":"unknown","updated_at":"2026-01-12T19:12:54.944612355Z","closed_at":"2026-01-12T18:29:08.554292342Z"}
{"id":"wx-ze6","title":"Add tests for deploy key setup and scripts","description":"Several components lack test coverage:\n\n**Missing tests:**\n1. scripts/setup-deploy-key - No tests for deploy key generation\n2. scripts/setup-tailscale-routing.sh - No tests\n3. deriveProfile function - No tests for profile derivation\n4. mkDevShell function - No tests\n5. Error conditions (mount failures, network failures, etc.)\n6. Deploy key workflow integration test\n\n**Impact:** Changes to these components can break without detection.\n\n**Fix:** Add test cases for these components in lib/tests/.","status":"closed","priority":3,"issue_type":"feature","created_at":"2026-01-10T19:51:18.67786336Z","created_by":"Wrapix Sandbox","updated_at":"2026-01-10T22:04:31.245726982Z","closed_at":"2026-01-10T22:04:31.245726982Z","close_reason":"Re-closing after container restart"}
{"id":"wx-zu8","title":"Fix Darwin container networking","description":"Container starts but networking doesn't work. NAT interface is configured with 10.0.0.2/24 and gateway 10.0.0.1 but Claude can't reach the network. Need to debug DNS resolution and network connectivity inside the VM.","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-08T11:06:33.200646Z","created_by":"shaun","updated_at":"2026-01-08T20:04:16.898636Z","closed_at":"2026-01-08T20:04:16.898636Z","close_reason":"Closed"}
